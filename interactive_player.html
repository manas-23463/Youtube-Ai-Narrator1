<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Learning Video Player</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@vime/core@^5/themes/default.css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/@vime/core@^5/dist/vime/vime.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@vime/core@^5/dist/vime.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 50%, #533483 75%, #7209b7 100%);
            min-height: 100vh;
            color: #ffffff;
            position: relative;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: #ffffff;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 15px;
            color: #ffffff;
            letter-spacing: -0.02em;
        }

        .header p {
            font-size: 1.2rem;
            color: #a0aec0;
            font-weight: 400;
        }

        .url-input-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 35px;
            margin-bottom: 35px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .url-input-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        }

        .url-input {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .url-input input {
            flex: 1;
            padding: 16px 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            transition: all 0.3s ease;
            font-weight: 400;
        }

        .url-input input:focus {
            outline: none;
            border-color: #00d4ff;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
        }

        .url-input input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .url-input button {
            padding: 16px 32px;
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .url-input button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.4);
        }

        .url-input button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .url-input button:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .player-container {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 35px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        #youtube-player {
            width: 100%;
            height: 500px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 
                0 12px 24px rgba(0, 0, 0, 0.15),
                0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* S3 Video Player specific styling */
        #youtube-player.s3-mode {
            height: 600px !important;
            min-height: 600px;
            max-height: none !important;
            overflow: visible !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 0 !important;
            position: relative !important;
        }

        #s3-video-player {
            width: auto !important;
            height: auto !important;
            max-width: 100% !important;
            max-height: 100% !important;
            object-fit: contain !important;
            border-radius: 15px;
            display: block !important;
            margin: 0 auto !important;
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
        }

        .floating-cta {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .floating-cta:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.4);
        }

        .floating-cta:active {
            transform: translateY(-1px);
        }

        .glassmorphic-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border-radius: 30px;
            padding: 45px;
            max-width: 600px;
            width: 90%;
            box-shadow: 
                0 32px 64px rgba(0, 0, 0, 0.3),
                0 16px 32px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.4);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glassmorphic-popup.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .popup-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(0,0,0,0.1);
            color: #333;
        }

        .popup-content {
            margin-bottom: 25px;
        }

        .summary-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .summary-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .summary-text {
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .transcript-section {
            background: rgba(0,0,0,0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .transcript-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .transcript-text {
            line-height: 1.5;
            font-size: 0.9rem;
            color: #666;
            max-height: 200px;
            overflow-y: auto;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 8px;
        }

        .popup-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-top: 20px;
        }

        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .primary-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .secondary-btn {
            background: rgba(0,0,0,0.1);
            color: #333;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        /* AI Avatar Styles */
        .avatar-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .avatar-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 24px;
            justify-content: center;
        }
        .avatar-video-container {
            margin-right: 0;
        }


        .avatar-video-container {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .avatar-video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-status {
            font-size: 0.9rem;
            color: white;
            opacity: 0.9;
            text-align: center;
        }

        .settings-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .settings-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #ffffff;
        }

        .setting-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: #ffffff;
        }

        .setting-label {
            font-weight: 500;
        }

        .setting-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 56px;
            height: 28px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 28px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            box-shadow: 0 2px 8px rgba(0, 212, 255, 0.3);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active::after {
            transform: translateX(28px);
        }

        .interval-input {
            width: 80px;
            padding: 10px 14px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            text-align: center;
            font-weight: 400;
            transition: all 0.3s ease;
        }

        .interval-input:focus {
            outline: none;
            border-color: #00d4ff;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.2);
        }

        .loading {
            text-align: center;
            color: #ffffff;
            font-size: 1.1rem;
            margin: 40px 0;
        }

        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        /* New styles for AI Avatar */
        .avatar-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .avatar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .avatar-video-container {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .avatar-video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-status {
            font-size: 0.9rem;
            color: white;
            opacity: 0.9;
            text-align: center;
        }

        /* Animated Avatar Placeholder */
        .avatar-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .avatar-face {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .avatar-eyes {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .avatar-eye {
            width: 12px;
            height: 12px;
            background: #4a90e2;
            border-radius: 50%;
            position: relative;
            animation: blink 4s infinite;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .avatar-eye::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 4px;
            height: 4px;
            background: #fff;
            border-radius: 50%;
        }

        .avatar-eye.left {
            animation-delay: 0s;
        }

        .avatar-eye.right {
            animation-delay: 0s;
        }

        .avatar-mouth {
            width: 24px;
            height: 12px;
            border: 2px solid #333;
            border-top: none;
            border-radius: 0 0 24px 24px;
            animation: talk 2s infinite;
            transition: all 0.3s ease;
        }

        @keyframes blink {
            0%, 85%, 100% { 
                transform: scaleY(1); 
                opacity: 1;
            }
            90%, 95% { 
                transform: scaleY(0.1); 
                opacity: 0.3;
            }
        }

        @keyframes talk {
            0%, 100% { 
                transform: scaleY(1); 
                border-radius: 0 0 24px 24px;
            }
            50% { 
                transform: scaleY(1.3); 
                border-radius: 0 0 20px 20px;
            }
        }

        .avatar-section.talking .avatar-mouth {
            animation: talk 0.3s infinite;
            background: #ff6b9d;
            border-color: #ff6b9d;
            border-radius: 0 0 30px 30px;
            transform: scaleY(1.2);
        }

        /* Chat Interface Styles */
        .chat-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            max-height: 350px;
            overflow: hidden;
        }

        .chat-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
            text-align: center;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 250px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 12px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            max-height: 150px;
        }

        .chat-message {
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
        }

        .chat-message.user-message {
            align-items: flex-end;
        }

        .chat-message.bot-message {
            align-items: flex-start;
        }

        .message-content {
            max-width: 85%;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            line-height: 1.3;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .user-message .message-content {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .bot-message .message-content {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .chat-input-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        #chat-input {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 0.85rem;
            outline: none;
            max-width: 200px;
        }

        #chat-input:focus {
            background: white;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }

        #chat-send-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        #chat-send-btn:hover {
            background: white;
            transform: translateY(-1px);
        }

        #chat-send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #chat-toggle-btn {
            background: linear-gradient(135deg, #667eea, #764ba2) !important;
            color: white !important;
            font-size: 0.9rem;
            padding: 10px 16px;
            white-space: nowrap;
        }

        #chat-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        /* Ensure popup actions stay within bounds */
        .popup-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 18px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-top: 20px;
            flex-wrap: wrap;
            max-width: 100%;
        }

        .action-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: fit-content;
        }

        /* Ensure popup content doesn't overflow */
        .popup-content {
            margin-bottom: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            .chat-section {
                max-height: 300px;
                padding: 15px;
            }
            
            .chat-container {
                height: 200px;
            }
            
            .chat-messages {
                max-height: 120px;
            }
            
            .popup-actions {
                gap: 8px;
                padding: 15px;
            }
            
            .action-btn {
                padding: 8px 14px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì AI Learning Video Player</h1>
            <p>Transform any YouTube video into an interactive learning experience</p>
        </div>

        <div class="url-input-section">
            <div class="url-input">
                <input type="text" id="youtube-url" placeholder="Paste YouTube or S3 video URL here..." />
                <input type="file" id="local-file" accept="video/*" style="display:none" />
                <button id="load-btn" onclick="loadVideo()">üöÄ Load Video</button>
                <button id="upload-btn" onclick="document.getElementById('local-file').click()">Upload File</button>
            </div>
        </div>

        <div class="settings-panel">
            <div class="settings-title">‚öôÔ∏è Player Settings</div>
            <div class="setting-group">
                <span class="setting-label">Auto-trigger pop-ups</span>
                <div class="setting-control">
                    <div class="toggle-switch" id="auto-trigger" onclick="toggleSetting('auto-trigger')"></div>
                </div>
            </div>
            <div class="setting-group">
                <span class="setting-label" for="trigger-interval">Interval (seconds)</span>
                <div class="setting-control">
                    <input type="number" class="interval-input" id="trigger-interval" value="30" min="10" max="120" />
                </div>
            </div>
            <div class="setting-group">
                <span class="setting-label">Show AI Avatar</span>
                <div class="setting-control">
                    <div class="toggle-switch" id="show-avatar" onclick="toggleSetting('show-avatar')"></div>
                </div>
            </div>
            <div class="setting-group">
                <span class="setting-label">Background Music</span>
                <div class="setting-control">
                    <div class="toggle-switch" id="bgm-enabled" onclick="toggleSetting('bgm-enabled')"></div>
                </div>
            </div>
        </div>

        <div class="player-container">
            <div id="youtube-player"></div>
            <div id="s3-player" style="display:none; width: 100%; height: 500px; border-radius: 15px; overflow: hidden;"></div>
            <button class="floating-cta avatar-cta hidden" id="explain-btn" onclick="triggerManualPopup()" style="background: none; box-shadow: none; padding: 0; border: none; width: 70px; height: 70px;">
                <img src="avatar_button.png" alt="Explain" style="width: 70px; height: 70px; border-radius: 50%; box-shadow: 0 4px 16px rgba(0,0,0,0.18); border: 3px solid #fff; background: #f8f8ff; object-fit: cover;" />
            </button>
        </div>

        <div class="loading hidden" id="loading">
            <div class="spinner"></div>
            <div>Processing video and generating AI insights...</div>
        </div>
    </div>

    <!-- Glassmorphic Popup -->
    <div class="glassmorphic-popup" id="learning-popup">
        <div class="popup-header">
            <div class="popup-title">ü§ñ AI Learning Assistant</div>
            <button class="close-btn" onclick="closePopup()">√ó</button>
        </div>
        
        <div class="popup-content">
            <!-- AI Avatar Section -->
            <div class="avatar-section" id="avatar-section" style="display: none;">
                <div class="avatar-container">
                    <div class="avatar-video-container">
                        <div class="avatar-placeholder">
                            <div class="avatar-face">
                                <div class="avatar-eyes">
                                    <div class="avatar-eye left"></div>
                                    <div class="avatar-eye right"></div>
                                </div>
                                <div class="avatar-mouth"></div>
                            </div>
                        </div>
                    </div>
                    <div class="avatar-status">ü§ñ AI Avatar Explaining...</div>
                </div>
            </div>
            
            <div class="summary-section">
                <div class="summary-title">üìù AI Summary</div>
                <div class="summary-text" id="summary-text">
                    Loading AI-generated summary...
                </div>
            </div>
            
            <div class="chat-section" id="chat-section" style="display: none;">
                <div class="chat-title">üí¨ Ask Questions About This Video</div>
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <div class="chat-message bot-message">
                            <div class="message-content">
                                Hi! I'm here to help you understand this video better. Ask me any questions about what was discussed!
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chat-input" placeholder="Type your question here..." maxlength="500" />
                        <button id="chat-send-btn" onclick="sendChatMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="popup-actions">
            <button id="ai-narration-btn" class="action-btn secondary-btn" style="display:none;">‚ñ∂Ô∏è Start AI Narration</button>
            <button id="chat-toggle-btn" class="action-btn secondary-btn" onclick="toggleChat()">
                üí¨ Ask Questions
            </button>
            <button class="action-btn secondary-btn" onclick="closePopup()">
                ‚úã Continue Watching
            </button>
        </div>
    </div>

    <script>
        // Global variables
        let player;
        let currentVideoId = '';
        let videoSegments = [];
        let currentSegmentIndex = 0;
        let autoTriggerEnabled = false;
        let triggerInterval = 30;
        let showAvatar = false;
        let bgmEnabled = false;
        let lastTriggerTime = 0;
        let isProcessing = false;
        let apiBaseUrl = 'http://localhost:8002';
        
        // New variables for chapter-based system
        let videoChapters = [];
        let hasChapters = false;
        let currentChapterIndex = 0;
        let chapterTimer = null;
        let timeTrackingTimer = null; // Add this for time-based tracking
        
        // HeyGen Avatar URLs - Random selection of professional avatars
        const avatarUrls = [
            'https://app.heygen.com/avatar/65f7c8b8e4b0b8b8b8b8b8b8', // Professional male
            'https://app.heygen.com/avatar/65f7c8b8e4b0b8b8b8b8b8b9', // Professional female
            'https://app.heygen.com/avatar/65f7c8b8e4b0b8b8b8b8b8ba', // Casual male
            'https://app.heygen.com/avatar/65f7c8b8e4b0b8b8b8b8b8bb', // Casual female
            'https://app.heygen.com/avatar/65f7c8b8e4b0b8b8b8b8b8bc'  // Friendly instructor
        ];

        // AI Narration audio state
        let aiNarrationAudio = null;
        let isNarrationPlaying = false;

        // YouTube API callback
        function onYouTubeIframeAPIReady() {
            console.log('YouTube API ready, initializing player...');
            player = new YT.Player('youtube-player', {
                height: '500',
                width: '100%',
                videoId: '',
                playerVars: {
                    'playsinline': 1,
                    'controls': 1,
                    'rel': 0
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }

        function onPlayerReady(event) {
            console.log('YouTube player ready');
            // Enable the load button
            document.getElementById('load-btn').disabled = false;
            document.getElementById('load-btn').textContent = 'üöÄ Load Video';
        }

        function onPlayerError(event) {
            console.error('YouTube player error:', event);
            alert('Error loading YouTube player. Please refresh the page and try again.');
        }

        function onPlayerStateChange(event) {
            // Skip YouTube player state changes when using S3 videos
            if (window.currentVideoType === 's3') {
                console.log('‚è≠Ô∏è Skipping YouTube player state change for S3 video');
                return;
            }
            
            console.log('YouTube player state changed:', event.data);
            
            if (event.data === YT.PlayerState.PLAYING) {
                console.log('‚ñ∂Ô∏è YouTube video started playing');
                if (autoTriggerEnabled) {
                    if (hasChapters && videoChapters.length > 0) {
                        startChapterTracking();
                    } else {
                        startTimeTracking();
                    }
                }
            } else if (event.data === YT.PlayerState.PAUSED) {
                console.log('‚è∏Ô∏è YouTube video paused');
                // Stop all tracking
                if (chapterTimer) {
                    clearInterval(chapterTimer);
                    chapterTimer = null;
                }
                if (timeTrackingTimer) {
                    clearInterval(timeTrackingTimer);
                    timeTrackingTimer = null;
                }
            } else if (event.data === YT.PlayerState.ENDED) {
                console.log('‚èπÔ∏è YouTube video ended');
                // Stop all tracking
                if (chapterTimer) {
                    clearInterval(chapterTimer);
                    chapterTimer = null;
                }
                if (timeTrackingTimer) {
                    clearInterval(timeTrackingTimer);
                    timeTrackingTimer = null;
                }
            }
        }

        async function loadVideo() {
            const url = document.getElementById('youtube-url').value;
            console.log('üîç Attempting to load video with URL:', url);
            
            const videoInfo = extractVideoId(url);
            console.log('üìã Extracted video info:', videoInfo);
            
            if (!videoInfo) {
                alert('Please enter a valid YouTube or S3 video URL');
                return;
            }

            currentVideoId = videoInfo.id;
            console.log('üéØ Current video ID:', currentVideoId);
            console.log('üé¨ Video type:', videoInfo.type);
            
            // Show loading state
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('explain-btn').classList.add('hidden');
            
            try {
                if (videoInfo.type === 'youtube') {
                    // Ensure containers visibility
                    const yt = document.getElementById('youtube-player');
                    const s3c = document.getElementById('s3-player');
                    if (s3c) s3c.style.display = 'none';
                    if (yt) yt.style.display = '';
                    
                    // Check if YouTube player is ready only for YouTube videos
                    if (!player || !player.loadVideoById) {
                        alert('YouTube player is not ready yet. Please wait a moment and try again.');
                        return;
                    }
                    
                    // Handle YouTube video (existing logic)
                    console.log('üé¨ Loading YouTube video:', videoInfo.id);
                    
                    // Set global video type
                    window.currentVideoType = 'youtube';
                    
                    // Restore YouTube player if it was replaced by S3 player
                    // We now just ensure the S3 container is hidden
                    
                    // Load video into YouTube player
                    if (player && player.loadVideoById) {
                        player.loadVideoById(videoInfo.id);
                        console.log('‚úÖ YouTube video loaded into player');
                    } else {
                        console.error('‚ùå YouTube player not available');
                        throw new Error('YouTube player not available');
                    }
                    
                    // Process YouTube video through backend API to enable AI features
                    console.log('ü§ñ Processing YouTube video for AI features...');
                    processYouTubeVideoForAI(videoInfo.id);
                    
                    // The processYouTubeVideoForAI function now handles all chapter detection and mode setting
                    // No need for additional setTimeout or chapter checking here
                    
                } else if (videoInfo.type === 's3') {
                    // Ensure containers visibility
                    const yt = document.getElementById('youtube-player');
                    const s3c = document.getElementById('s3-player');
                    if (yt) yt.style.display = 'none';
                    if (s3c) s3c.style.display = '';
                    
                    // Handle S3 video (new logic) - no YouTube player required
                    console.log('üé¨ Loading S3 video:', videoInfo.id);
                    console.log('üîç Video info object:', videoInfo);
                    
                    // Set global video type to prevent YouTube player errors
                    window.currentVideoType = 's3';
                    
                    try {
                        // Set up S3 video player using Vime
                        console.log('‚öôÔ∏è Setting up S3 Vime player...');
                        setupS3PlayerWithVime(videoInfo.id);
                        
                        // Process S3 video through backend API to enable AI features
                        console.log('ü§ñ Processing S3 video for AI features...');
                        processS3VideoForAI(videoInfo.id);
                        
                        // Wait a moment for the player to be set up
                        setTimeout(() => {
                            console.log('‚úÖ S3 player verification step complete (Vime)');
                            
                            // S3 videos don't have chapters, use time-based intervals
                                hasChapters = false;
                                videoChapters = [];
                            console.log('‚úÖ S3 video - chapters disabled, using time-based intervals');
                            
                            // Update UI to show time-based mode
                            const triggerLabel = document.querySelector('.setting-label[for="trigger-interval"]');
                            const triggerInput = document.getElementById('trigger-interval');
                            
                            if (triggerLabel && triggerInput) {
                                triggerLabel.textContent = 'Interval (seconds)';
                                triggerInput.disabled = false;
                                triggerInput.value = triggerInterval.toString();
                                console.log('‚úÖ UI updated for time-based mode');
                        } else {
                                console.warn('‚ö†Ô∏è Could not find trigger interval elements');
                            }
                            
                            // Update header
                            const header = document.querySelector('.header h1');
                            if (header) {
                                header.textContent = `üéì S3 Video Player`;
                                console.log('‚úÖ Header updated for S3 video');
                    } else {
                                console.warn('‚ö†Ô∏è Could not find header element');
                            }
                            
                    // For S3 videos, we'll use time-based tracking only
                            console.log('‚è∞ S3 video - starting time-based tracking');
                    
                    // Start time-based tracking
                    startTimeTracking();
                    debugTrackingState();
                            
                            console.log('‚úÖ S3 video setup complete');
                            
                        }, 500); // Give the player setup time to complete
                        
                    } catch (s3Error) {
                        console.error('‚ùå Error setting up S3 video:', s3Error);
                        throw new Error(`S3 video setup failed: ${s3Error.message}`);
                    }
                } else {
                    console.error('‚ùå Unknown video type:', videoInfo.type);
                    throw new Error(`Unknown video type: ${videoInfo.type}`);
                }
                
            } catch (error) {
                console.error('Error processing video:', error);
                console.error('Error details:', error);
                
                let errorMessage = 'Unknown error occurred';
                if (error.message) {
                    errorMessage = error.message;
                } else if (error.response) {
                    errorMessage = `HTTP ${error.response.status}: ${error.response.statusText}`;
                }
                
                alert(`Error processing video: ${errorMessage}`);
                
                // Don't use fallback data - show real error
                // initializeDummySegments();
            } finally {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('explain-btn').classList.remove('hidden');
            }
        }

        function initializeDummySegments() {
            // Fallback dummy segments for testing
            videoSegments = [
                {
                    start: 0,
                    end: 30,
                    transcript: "Welcome to this comprehensive guide on artificial intelligence and machine learning. In this video, we'll explore the fundamental concepts that drive modern AI systems and how they're transforming our world.",
                    summary: "Introduction to AI and ML concepts, setting the foundation for understanding modern technology and its applications."
                },
                {
                    start: 30,
                    end: 60,
                    transcript: "Machine learning algorithms can be broadly categorized into supervised, unsupervised, and reinforcement learning. Each type serves different purposes and applications in solving real-world problems.",
                    summary: "Overview of the three main types of machine learning algorithms and their practical applications in various industries."
                },
                {
                    start: 60,
                    end: 90,
                    transcript: "Deep learning uses neural networks with multiple layers to process complex patterns. These networks can learn hierarchical representations of data, making them powerful for tasks like image recognition and natural language processing.",
                    summary: "Explanation of deep learning and neural network architecture for complex pattern recognition and advanced AI applications."
                },
                {
                    start: 90,
                    end: 120,
                    transcript: "The future of AI lies in combining these different approaches to create more intelligent and adaptable systems that can learn and evolve over time.",
                    summary: "Future prospects of AI technology and the potential for creating more advanced, adaptive intelligent systems."
                }
            ];
            
            currentSegmentIndex = 0;
            lastTriggerTime = 0;
            
            console.log('Initialized dummy segments:', videoSegments.length, 'segments');
        }

        function extractVideoId(url) {
            // Prefer S3/local detection FIRST
            const s3HostPattern = /https?:\/\/([^.]+\.)?s3[.-][a-z0-9-]+\.amazonaws\.com\//i;
            const s3VirtualHostPattern = /https?:\/\/[^\/]+\.s3\.amazonaws\.com\//i;
            const hasVideoExt = /\.(mp4|webm|mov|m4v|avi|mkv)(?:\?|#|$)/i;
            if (s3HostPattern.test(url) || s3VirtualHostPattern.test(url) || hasVideoExt.test(url) || url.startsWith('blob:')) {
                return { type: 's3', id: url };
            }
            // Then YouTube
            const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const youtubeMatch = url.match(youtubeRegex);
            if (youtubeMatch) {
                return { type: 'youtube', id: youtubeMatch[1] };
            }
            return null;
        }

        function startTimeTracking() {
            if (autoTriggerEnabled && !hasChapters) {
                // Clear any existing timers first
                if (chapterTimer) {
                    clearInterval(chapterTimer);
                    chapterTimer = null;
                }
                if (timeTrackingTimer) {
                    clearInterval(timeTrackingTimer);
                    timeTrackingTimer = null;
                }
                timeTrackingTimer = setInterval(checkAutoTrigger, 1000);
                console.log('Started time-based tracking');
            }
        }

        function startChapterTracking() {
            console.log('üöÄ startChapterTracking called with:', {
                autoTriggerEnabled,
                hasChapters,
                chaptersCount: videoChapters.length
            });
            
            if (autoTriggerEnabled && hasChapters && videoChapters.length > 0) {
                // Clear any existing timer
                if (chapterTimer) {
                    clearInterval(chapterTimer);
                    console.log('üõë Cleared existing chapter timer');
                }
                if (timeTrackingTimer) {
                    clearInterval(timeTrackingTimer);
                    timeTrackingTimer = null;
                    console.log('üõë Cleared time tracking timer');
                }
                
                // Check every second for chapter transitions
                chapterTimer = setInterval(checkChapterTransition, 1000);
                console.log('‚úÖ Started chapter-based tracking with timer ID:', chapterTimer);
                console.log('üìä Chapter data available:', videoChapters);
            } else {
                console.log('‚ùå startChapterTracking blocked:', {
                    autoTriggerEnabled,
                    hasChapters,
                    chaptersCount: videoChapters.length
                });
            }
        }

        function stopTimeTracking() {
            // Stop all tracking modes
            if (chapterTimer) {
                clearInterval(chapterTimer);
                chapterTimer = null;
            }
            if (timeTrackingTimer) {
                clearInterval(timeTrackingTimer);
                timeTrackingTimer = null;
            }
        }

        function checkChapterTransition() {
            if (!autoTriggerEnabled || isProcessing || !hasChapters || videoChapters.length === 0) {
                console.log('üö´ Chapter transition check blocked:', {
                    autoTriggerEnabled,
                    isProcessing,
                    hasChapters,
                    chaptersCount: videoChapters.length
                });
                return;
            }
            
            const currentTime = player.getCurrentTime();
            console.log(`üîç Checking chapter transition at ${currentTime}s`);
            
            // Find current chapter
            const currentChapter = videoChapters.find(chapter => 
                currentTime >= chapter.start_time && currentTime <= chapter.end_time
            );
            
            if (currentChapter) {
                const chapterIndex = videoChapters.indexOf(currentChapter);
                console.log(`üìç Currently in chapter: ${currentChapter.title} (index: ${chapterIndex})`);
                
                // Only trigger popup when we're near the end of the current chapter (within 1 second)
                // Don't trigger on chapter start or transition
                const timeUntilChapterEnd = currentChapter.end_time - currentTime;
                if (timeUntilChapterEnd <= 1 && timeUntilChapterEnd > 0) {
                    console.log(`‚è∞ Near end of chapter: ${currentChapter.title}, triggering popup`);
                    triggerChapterPopup(currentChapter);
                }
            } else {
                console.log('‚ùå Not in any chapter at current time');
            }
        }

        function checkAutoTrigger() {
            // Multiple safety checks to ensure this never runs with chapters
            if (!autoTriggerEnabled || isProcessing || hasChapters) {
                console.log('üö´ Auto trigger blocked:', {
                    autoTriggerEnabled,
                    isProcessing,
                    hasChapters,
                    currentTime: window.currentVideoType === 's3' ? 
                        (document.querySelector('#s3-player vm-player')?.currentTime || 0) : 
                        (player.getCurrentTime ? player.getCurrentTime() : 0)
                });
                return;
            }
            
            // Get current time based on video type
            let currentTime = 0;
            if (window.currentVideoType === 's3') {
                const s3Player = document.querySelector('#s3-player vm-player') || document.querySelector('vm-player');
                if (s3Player) {
                    currentTime = s3Player.currentTime || 0;
                }
            } else {
                currentTime = player.getCurrentTime();
            }
            const timeSinceLastTrigger = currentTime - lastTriggerTime;
            
            if (timeSinceLastTrigger >= triggerInterval) {
                console.log(`‚è∞ Time-based trigger: ${timeSinceLastTrigger}s elapsed, triggering popup at ${currentTime}s`);
                triggerPopup();
                lastTriggerTime = currentTime;
            }
        }

        function triggerManualPopup() {
            triggerPopup();
        }

        async function triggerPopup(segmentIndex = null, manual = false) {
            if (isProcessing) return;
            isProcessing = true;
           // Always show popup and reset state
           document.getElementById('learning-popup').classList.add('active');
           // Reset AI narration button and state
           const narrationBtn = document.getElementById('ai-narration-btn');
           if (narrationBtn) {
               narrationBtn.textContent = '‚ñ∂Ô∏è Start AI Narration';
               narrationBtn.disabled = false;
               narrationBtn.style.display = (showAvatar ? 'inline-block' : 'none');
           }
           if (aiNarrationAudio) {
               aiNarrationAudio.pause();
               aiNarrationAudio.currentTime = 0;
           }
           isNarrationPlaying = false;
           const avatarSection = document.getElementById('avatar-section');
           if (avatarSection) avatarSection.classList.remove('talking');
           setupAINarrationButton();
            
            // Get current time based on video type
            let currentTime = 0;
            if (window.currentVideoType === 's3') {
                const s3Player = document.querySelector('#s3-player vm-player') || document.querySelector('vm-player');
                if (s3Player) {
                    currentTime = s3Player.currentTime || 0;
                }
            } else {
                currentTime = player.getCurrentTime();
            }
            
            // Find current segment
            const currentSegment = findCurrentSegment(currentTime);
            
            // Check if there's enough content (at least 10 seconds)
            if (currentTime < 10) {
                // Show "not enough content" message
                document.getElementById('learning-popup').classList.add('active');
                document.getElementById('summary-text').textContent = 'There is not enough content yet to explain. Please continue watching.';
                
                // Pause video based on video type
                if (window.currentVideoType === 's3') {
                    const s3Player = document.querySelector('#s3-player vm-player') || document.querySelector('vm-player');
                    if (s3Player) {
                        s3Player.pause();
                    }
                } else {
                    player.pauseVideo();
                }
                
                // Show avatar if enabled
                showAvatarInPopup();
                
                // Play background music if enabled
                if (bgmEnabled) {
                    playBackgroundMusic();
                }
                
                isProcessing = false;
                return;
            }
            
            if (currentSegment) {
                // Pause video based on video type
                if (window.currentVideoType === 's3') {
                    const s3Player = document.querySelector('#s3-player vm-player') || document.querySelector('vm-player');
                    if (s3Player) {
                        s3Player.pause();
                    }
                } else {
                    player.pauseVideo();
                }
                
                // Show popup with loading state
                document.getElementById('summary-text').textContent = 'Generating time-specific explanation...';
                
                // Show avatar if enabled
                showAvatarInPopup();
                
                try {
                    // Generate time-specific explanation
                    const response = await fetch(`${apiBaseUrl}/learning-point`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            segment_index: videoSegments.indexOf(currentSegment),
                            timestamp: currentTime,
                            transcript: currentSegment.transcript,
                            current_time: currentTime,
                            segments: videoSegments // Pass all segments for accurate extraction
                        })
                    });

                    const result = await response.json();
                    console.log('Learning point API response:', result);
                    if (result.success && result.learning_point && result.learning_point.summary) {
                        // Update with time-specific explanation
                        document.getElementById('summary-text').textContent = result.learning_point.summary;
                        console.log('Generated time-specific explanation:', result.learning_point.summary);
                    } else if (result.error) {
                        document.getElementById('summary-text').textContent = 'Error: ' + result.error;
                    } else {
                        // Fallback to segment summary
                        document.getElementById('summary-text').textContent = currentSegment.summary;
                    }
                } catch (error) {
                    console.error('Error generating time-specific explanation:', error);
                    // Fallback to segment summary
                    document.getElementById('summary-text').textContent = currentSegment.summary;
                }
                
                // Play background music if enabled
                if (bgmEnabled) {
                    playBackgroundMusic();
                }

                // After updating summary text in triggerPopup, show Start AI Narration button if avatar is enabled
                const narrationBtn = document.getElementById('ai-narration-btn');
                if (showAvatar && narrationBtn) {
                    narrationBtn.style.display = 'inline-block';
                } else if (narrationBtn) {
                    narrationBtn.style.display = 'none';
                }
            }
            
            isProcessing = false;
        }

        async function triggerChapterPopup(chapter) {
            if (isProcessing) return;
            isProcessing = true;
            
            // Pause video based on video type
            if (window.currentVideoType === 's3') {
                const s3Player = document.querySelector('#s3-player vm-player') || document.querySelector('vm-player');
                if (s3Player) {
                    s3Player.pause();
                }
            } else {
                player.pauseVideo();
            }
            
            // Show popup
            document.getElementById('learning-popup').classList.add('active');
            document.getElementById('summary-text').textContent = `Chapter: ${chapter.title}\nGenerating chapter explanation...`;
            
            // Show avatar if enabled
            showAvatarInPopup();
            
            try {
                // Generate chapter-specific explanation
                const response = await fetch(`${apiBaseUrl}/learning-point`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        segment_index: currentChapterIndex,
                        timestamp: chapter.start_time,
                        transcript: `Chapter: ${chapter.title}`,
                        current_time: chapter.start_time,
                        segments: videoSegments,
                        chapter_info: {
                            title: chapter.title,
                            start_time: chapter.start_time,
                            end_time: chapter.end_time,
                            duration: chapter.duration
                        }
                    })
                });

                const result = await response.json();
                if (result.success && result.learning_point && result.learning_point.summary) {
                    document.getElementById('summary-text').textContent = result.learning_point.summary;
                } else if (result.error) {
                    document.getElementById('summary-text').textContent = 'Error: ' + result.error;
                } else {
                    document.getElementById('summary-text').textContent = `Chapter: ${chapter.title}\n\nThis chapter covers ${chapter.duration} seconds of content.`;
                }
            } catch (error) {
                console.error('Error generating chapter explanation:', error);
                document.getElementById('summary-text').textContent = `Chapter: ${chapter.title}\n\nThis chapter covers ${chapter.duration} seconds of content.`;
            }
            
            // Play background music if enabled
            if (bgmEnabled) {
                playBackgroundMusic();
            }
            
            // Show AI narration button if avatar is enabled
            const narrationBtn = document.getElementById('ai-narration-btn');
            if (showAvatar && narrationBtn) {
                narrationBtn.style.display = 'inline-block';
            } else if (narrationBtn) {
                narrationBtn.style.display = 'none';
            }
            
            isProcessing = false;
        }

        function findCurrentSegment(currentTime) {
            return videoSegments.find(segment => 
                currentTime >= segment.start && currentTime <= segment.end
            ) || videoSegments[0];
        }

        function closePopup() {
            document.getElementById('learning-popup').classList.remove('active');
            isProcessing = false;
            // Reset AI narration button and state
            const narrationBtn = document.getElementById('ai-narration-btn');
            if (narrationBtn) {
                narrationBtn.textContent = '‚ñ∂Ô∏è Start AI Narration';
                narrationBtn.disabled = false;
                narrationBtn.style.display = 'none';
            }
            if (aiNarrationAudio) {
                aiNarrationAudio.pause();
                aiNarrationAudio.currentTime = 0;
            }
            isNarrationPlaying = false;
            const avatarSection = document.getElementById('avatar-section');
            if (avatarSection) avatarSection.classList.remove('talking');
            
            // Resume video based on video type
            if (window.currentVideoType === 's3') {
                const s3Player = document.querySelector('#s3-player vm-player') || document.querySelector('vm-player');
                if (s3Player) {
                    s3Player.play();
                    console.log('‚úÖ S3 video resumed');
                }
            } else {
                // YouTube video
                if (player && player.playVideo) {
                    player.playVideo();
                    console.log('‚úÖ YouTube video resumed');
                }
            }
        }

        async function replaySummary() {
            let currentTime = 0;
            
            // Get current time based on video type
            if (window.currentVideoType === 's3') {
                const s3Player = document.querySelector('#s3-player vm-player') || document.querySelector('vm-player');
                if (s3Player) {
                    currentTime = s3Player.currentTime;
                }
            } else {
                // YouTube video
                if (player && player.getCurrentTime) {
                    currentTime = player.getCurrentTime();
                }
            }
            
            const currentSegment = findCurrentSegment(currentTime);
            
            if (currentSegment) {
                try {
                    // Generate time-specific explanation using API
                    const response = await fetch(`${apiBaseUrl}/learning-point`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            segment_index: videoSegments.indexOf(currentSegment),
                            timestamp: currentTime,
                            transcript: currentSegment.transcript,
                            current_time: currentTime
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success && result.learning_point && result.learning_point.summary) {
                        document.getElementById('summary-text').textContent = result.learning_point.summary;
                        console.log('Replayed summary:', result.learning_point.summary);
                    } else {
                        document.getElementById('summary-text').textContent = currentSegment.summary;
                    }
                } catch (error) {
                    console.error('Error replaying summary:', error);
                    document.getElementById('summary-text').textContent = currentSegment.summary;
                }
            }
        }

        async function savePoint() {
            const currentTime = player.getCurrentTime();
            const currentSegment = findCurrentSegment(currentTime);
            
            if (currentSegment) {
                try {
                    const response = await fetch(`${apiBaseUrl}/learning-point`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            segment_index: videoSegments.indexOf(currentSegment),
                            timestamp: currentTime,
                            transcript: currentSegment.transcript,
                            current_time: currentTime
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Learning point saved! üìö');
                        console.log('Saved learning point:', result.learning_point);
                    } else {
                        throw new Error(result.error || 'Failed to save learning point');
                    }
                } catch (error) {
                    console.error('Error saving learning point:', error);
                    alert(`Error saving learning point: ${error.message}`);
                }
            }
        }

        function playBackgroundMusic() {
            // Implement background music (could use Web Audio API)
            console.log('Playing background music...');
        }

        function getRandomAvatar() {
            // Get a random avatar from the list
            const randomIndex = Math.floor(Math.random() * avatarUrls.length);
            return avatarUrls[randomIndex];
        }

        // Chat functionality
        let chatEnabled = false;
        let chatHistory = [];

        function toggleChat() {
            const chatSection = document.getElementById('chat-section');
            const chatToggleBtn = document.getElementById('chat-toggle-btn');
            
            if (chatEnabled) {
                chatSection.style.display = 'none';
                chatToggleBtn.textContent = 'üí¨ Ask Questions';
                chatToggleBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2) !important';
            } else {
                chatSection.style.display = 'block';
                chatToggleBtn.textContent = '‚ùå Close Chat';
                chatToggleBtn.style.background = 'rgba(255,0,0,0.8) !important';
            }
            
            chatEnabled = !chatEnabled;
        }

        function sendChatMessage() {
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            const question = chatInput.value.trim();
            
            if (!question) return;
            
            // Disable input and button while processing
            chatInput.disabled = true;
            chatSendBtn.disabled = true;
            chatSendBtn.textContent = 'Sending...';
            
            // Add user message to chat
            addChatMessage(question, 'user');
            chatInput.value = '';
            
            // Get current video transcript
            const currentTime = player.getCurrentTime();
            const currentSegment = findCurrentSegment(currentTime);
            let videoTranscript = '';
            
            if (currentSegment && currentSegment.transcript) {
                videoTranscript = currentSegment.transcript;
            } else {
                // Fallback to all segments transcript
                videoTranscript = videoSegments.map(seg => seg.transcript).join(' ');
            }
            
            // Send question to API
            fetch(`${apiBaseUrl}/chat-question`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: question,
                    video_transcript: videoTranscript,
                    current_time: currentTime
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    addChatMessage(result.answer, 'bot');
                } else {
                    addChatMessage('Sorry, I encountered an error. Please try again.', 'bot');
                }
            })
            .catch(error => {
                console.error('Error sending chat message:', error);
                addChatMessage('Sorry, I encountered an error. Please try again.', 'bot');
            })
            .finally(() => {
                // Re-enable input and button
                chatInput.disabled = false;
                chatSendBtn.disabled = false;
                chatSendBtn.textContent = 'Send';
                chatInput.focus();
            });
        }

        function addChatMessage(message, sender) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = message;
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Store in history
            chatHistory.push({ sender, message, timestamp: new Date() });
        }

        // Debug function to check current state
        function debugTrackingState() {
            console.log('=== TRACKING STATE DEBUG ===');
            console.log('autoTriggerEnabled:', autoTriggerEnabled);
            console.log('hasChapters:', hasChapters);
            console.log('videoChapters:', videoChapters);
            console.log('currentChapterIndex:', currentChapterIndex);
            console.log('chapterTimer:', chapterTimer);
            console.log('timeTrackingTimer:', timeTrackingTimer);
            
            // Get current time based on video type
            let currentTime = 0;
            if (window.currentVideoType === 's3') {
                const s3Player = document.querySelector('#s3-player vm-player') || document.querySelector('vm-player');
                if (s3Player) {
                    currentTime = s3Player.currentTime || 0;
                }
            } else {
                currentTime = player.getCurrentTime();
            }
            
            console.log('currentTime:', currentTime);
            console.log('lastTriggerTime:', lastTriggerTime);
            console.log('triggerInterval:', triggerInterval);
            console.log('timeSinceLastTrigger:', currentTime - lastTriggerTime);
            console.log('==========================');
        }

        // Test function to manually check chapters
        async function testChapterDetection() {
            if (!currentVideoId) {
                console.log('‚ùå No video loaded. Please load a video first.');
                return;
            }
            
            console.log('üß™ Testing chapter detection for video:', currentVideoId);
            console.log('API URL:', `${apiBaseUrl}/video-chapters/${currentVideoId}`);
            
            try {
                const response = await fetch(`${apiBaseUrl}/video-chapters/${currentVideoId}`);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üìä Raw API Response:', data);
                
                if (data.success) {
                    console.log('‚úÖ API call successful');
                    console.log('has_chapters:', data.has_chapters);
                    console.log('total_chapters:', data.total_chapters);
                    console.log('chapters array:', data.chapters);
                    
                    if (data.chapters && Array.isArray(data.chapters)) {
                        console.log('üìö Chapters array is valid');
                        console.log('Array length:', data.chapters.length);
                        
                        if (data.chapters.length > 0) {
                            console.log('üéØ First chapter:', data.chapters[0]);
                            console.log('Chapter keys:', Object.keys(data.chapters[0]));
                        }
                    } else {
                        console.log('‚ùå Chapters array is invalid');
                        console.log('Type:', typeof data.chapters);
                    }
                } else {
                    console.log('‚ùå API call failed');
                    console.log('Error:', data.error);
                }
            } catch (error) {
                console.error('‚ùå Error testing chapter detection:', error);
            }
        }

        function showAvatarInPopup() {
            if (showAvatar) {
                const avatarSection = document.getElementById('avatar-section');
                if (!avatarSection) return;
                // Show avatar section
                avatarSection.style.display = 'block';
                // (No longer overwrite innerHTML here)
            } else {
                // Hide avatar section
                document.getElementById('avatar-section').style.display = 'none';
            }
        }

        function toggleSetting(settingId) {
            const toggle = document.getElementById(settingId);
            toggle.classList.toggle('active');
            
            switch(settingId) {
                case 'auto-trigger':
                    autoTriggerEnabled = toggle.classList.contains('active');
                    
                    // Start appropriate tracking based on video type
                    if (autoTriggerEnabled) {
                        if (hasChapters && videoChapters.length > 0) {
                            console.log('Auto-trigger enabled - starting chapter tracking');
                            startChapterTracking();
                        } else {
                            console.log('Auto-trigger enabled - starting time tracking');
                            startTimeTracking();
                        }
                    } else {
                        // Stop all tracking
                        console.log('Auto-trigger disabled - stopping all tracking');
                        if (chapterTimer) {
                            clearInterval(chapterTimer);
                            chapterTimer = null;
                        }
                        if (timeTrackingTimer) {
                            clearInterval(timeTrackingTimer);
                            timeTrackingTimer = null;
                        }
                    }
                    break;
                    
                case 'show-avatar':
                    showAvatar = toggle.classList.contains('active');
                    // Update avatar display if popup is currently open
                    if (document.getElementById('learning-popup').classList.contains('active')) {
                        showAvatarInPopup();
                    }
                    break;
                    
                case 'bgm-enabled':
                    bgmEnabled = toggle.classList.contains('active');
                    break;
            }
        }

        // Update interval when changed
        document.getElementById('trigger-interval').addEventListener('change', function() {
            triggerInterval = parseInt(this.value);
        });

        // Robustly attach event listener for Start/Stop AI Narration button
        function setupAINarrationButton() {
            const narrationBtn = document.getElementById('ai-narration-btn');
            if (!narrationBtn) return;
            // Remove previous listeners
            const newBtn = narrationBtn.cloneNode(true);
            narrationBtn.parentNode.replaceChild(newBtn, narrationBtn);
            newBtn.addEventListener('click', async function() {
                if (!isNarrationPlaying) {
                    newBtn.disabled = true;
                    newBtn.textContent = 'Loading...';
                    const summaryText = document.getElementById('summary-text').textContent;
                    const resp = await fetch(apiBaseUrl + '/tts-narration', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: summaryText, voice_id: 'RvxJMEXhmyfed4d7O5xn' })
                    });
                    const data = await resp.json();
                    if (data.success) {
                        aiNarrationAudio = new Audio('data:audio/mp3;base64,' + data.audio_base64);
                        isNarrationPlaying = true;
                        newBtn.textContent = '‚èπÔ∏è Stop AI Narration';
                        newBtn.disabled = false;
                        const avatarSection = document.getElementById('avatar-section');
                        if (avatarSection) avatarSection.classList.add('talking');
                        aiNarrationAudio.play();
                        aiNarrationAudio.onended = () => {
                            isNarrationPlaying = false;
                            newBtn.textContent = '‚ñ∂Ô∏è Start AI Narration';
                            if (avatarSection) avatarSection.classList.remove('talking');
                        };
                    } else {
                        newBtn.textContent = 'Error';
                        setTimeout(()=>{ newBtn.textContent = '‚ñ∂Ô∏è Start AI Narration'; newBtn.disabled = false; }, 2000);
                    }
                } else {
                    if (aiNarrationAudio) {
                        aiNarrationAudio.pause();
                        aiNarrationAudio.currentTime = 0;
                    }
                    isNarrationPlaying = false;
                    newBtn.textContent = '‚ñ∂Ô∏è Start AI Narration';
                    const avatarSection = document.getElementById('avatar-section');
                    if (avatarSection) avatarSection.classList.remove('talking');
                }
            });
        }

        // No global event listener needed for AI narration button
        document.addEventListener('DOMContentLoaded', function() {
            // Set default settings
            document.getElementById('auto-trigger').classList.add('active');
            autoTriggerEnabled = true;
            
            // Check if YouTube API loaded after 10 seconds
            setTimeout(function() {
                if (!player || !player.loadVideoById) {
                    console.warn('YouTube API not loaded, enabling fallback');
                    document.getElementById('load-btn').disabled = false;
                    document.getElementById('load-btn').textContent = 'üöÄ Load Video (Fallback)';
                }
            }, 10000);

            // Add event listener for Play AI Narration button
            const playBtn = document.getElementById('play-narration-btn');
            if (playBtn) {
                playBtn.addEventListener('click', async function() {
                    const summaryText = document.getElementById('summary-text').textContent;
                    playBtn.disabled = true;
                    playBtn.textContent = 'Loading...';
                    // Fetch TTS audio
                    const resp = await fetch(apiBaseUrl + '/tts-narration', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: summaryText, voice_id: 'RvxJMEXhmyfed4d7O5xn' })
                    });
                    const data = await resp.json();
                    if (data.success) {
                        // Play audio
                        const audio = new Audio('data:audio/mp3;base64,' + data.audio_base64);
                        // Animate avatar mouth
                        const avatarSection = document.getElementById('avatar-section');
                        if (avatarSection) avatarSection.classList.add('talking');
                        audio.play();
                        audio.onended = () => {
                            if (avatarSection) avatarSection.classList.remove('talking');
                            playBtn.disabled = false;
                            playBtn.textContent = '‚ñ∂Ô∏è Play AI Narration';
                        };
                    } else {
                        playBtn.textContent = 'Error';
                        setTimeout(()=>{ playBtn.textContent = '‚ñ∂Ô∏è Play AI Narration'; playBtn.disabled = false; }, 2000);
                    }
                });
            }

            // Add event listener for Start/Stop AI Narration button
            setupAINarrationButton();
            
            // Add Enter key support for chat input
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
            }
        });

        function setupS3Player(s3Url) {
            console.log('üé¨ Setting up S3 video player with URL:', s3Url);
            
            try {
                // Use backend proxy to avoid CORS/Range issues
                const proxiedUrl = `${apiBaseUrl}/s3-playable?url=${encodeURIComponent(s3Url)}`;
                
                // Find the YouTube player container
            const playerContainer = document.getElementById('youtube-player');
                if (!playerContainer) {
                    console.error('‚ùå YouTube player container not found');
                    return;
                }
            
                console.log('‚úÖ Found player container, clearing content...');
                
                // Clear the container completely
            playerContainer.innerHTML = '';
            
            // Add S3 mode class to container
            playerContainer.classList.add('s3-mode');
            
                // Create the video element
            const videoElement = document.createElement('video');
            videoElement.id = 's3-video-player';
            videoElement.controls = true;
                videoElement.playsInline = true;
                videoElement.preload = 'metadata';
                videoElement.crossOrigin = 'anonymous';
                videoElement.style.width = 'auto';
                videoElement.style.height = 'auto';
                videoElement.style.maxWidth = '100%';
                videoElement.style.maxHeight = '100%';
                videoElement.style.borderRadius = '12px';
                videoElement.style.backgroundColor = '#000';
                videoElement.style.objectFit = 'contain';
                videoElement.style.display = 'block';
                videoElement.style.margin = '0 auto';
                
                // Create source element
            const sourceElement = document.createElement('source');
                sourceElement.src = proxiedUrl;
            sourceElement.type = 'video/mp4';
            
                // Add fallback text
                const fallbackText = document.createTextNode('Your browser does not support the video tag.');
                
                // Assemble the video element
            videoElement.appendChild(sourceElement);
                videoElement.appendChild(fallbackText);
            
                // Add the video to the container
            playerContainer.appendChild(videoElement);
            
                console.log('‚úÖ Video element created and added to container');
                
                // Wait for the video element to be in the DOM, then add event listeners
                const checkAndSetup = () => {
                    const s3Player = document.getElementById('s3-video-player');
                    if (s3Player) {
                        console.log('‚úÖ S3 video player element found, adding event listeners...');
            
            // Add event listeners for S3 player
                        try {
                            s3Player.addEventListener('loadedmetadata', () => {
                                console.log('‚úÖ S3 video metadata loaded', { duration: s3Player.duration });
                                
                                // Calculate container size based on video dimensions
                                const videoWidth = s3Player.videoWidth;
                                const videoHeight = s3Player.videoHeight;
                                const containerWidth = playerContainer.offsetWidth;
                                
                                // Calculate the height that maintains aspect ratio
                                const aspectRatio = videoHeight / videoWidth;
                                const calculatedHeight = containerWidth * aspectRatio;
                                
                                // Set container height to fit video perfectly
                                playerContainer.style.height = `${calculatedHeight}px`;
                                playerContainer.style.overflow = 'visible';
                                playerContainer.style.maxHeight = 'none';
                                
                                // Ensure video fits properly
                                s3Player.style.height = `${calculatedHeight}px`;
                                s3Player.style.maxHeight = 'none';
                                
                                console.log('üìê Video dimensions:', { videoWidth, videoHeight, aspectRatio, calculatedHeight });
                            });
                            s3Player.addEventListener('error', (e) => {
                                console.error('‚ùå S3 video error:', e, s3Player.error);
                            });
                            s3Player.addEventListener('timeupdate', handleS3TimeUpdate);
                            s3Player.addEventListener('play', handleS3Play);
                            s3Player.addEventListener('pause', handleS3Pause);
                            s3Player.addEventListener('ended', handleS3Ended);
                            
                            console.log('‚úÖ S3 video player setup complete - all event listeners added');
                            
                            // Explicitly call load to fetch metadata via proxy
                            s3Player.load();
                            console.log('‚úÖ Video load() called');
                            
                        } catch (listenerError) {
                            console.error('‚ùå Error adding event listeners:', listenerError);
                        }
                    } else {
                        console.log('‚è≥ Waiting for S3 player element...');
                        setTimeout(checkAndSetup, 50);
                    }
                };
                
                // Start checking for the element
                checkAndSetup();
                
                // Add a safety fallback: if playable endpoint fails, swap to proxy
                setTimeout(() => {
                    const s3Player = document.getElementById('s3-video-player');
                    if (!s3Player) return;
                    
                    const tryFallback = () => {
                        const currentSrc = s3Player.currentSrc || (s3Player.querySelector('source')?.src || '');
                        if (currentSrc.includes('/s3-playable')) {
                            console.warn('‚ö†Ô∏è Falling back to s3-proxy due to playable load error/timeout');
                            const proxyUrl = `${apiBaseUrl}/s3-proxy?url=${encodeURIComponent(s3Url)}`;
                            const sourceEl = s3Player.querySelector('source');
                            if (sourceEl) sourceEl.src = proxyUrl;
                            else s3Player.src = proxyUrl;
                            s3Player.load();
                        }
                    };
                    
                    // If no metadata within 3s, fallback
                    let metaLoaded = false;
                    s3Player.addEventListener('loadedmetadata', () => { metaLoaded = true; }, { once: true });
                    setTimeout(() => { if (!metaLoaded) tryFallback(); }, 3000);
                    
                    // If error fires, fallback
                    s3Player.addEventListener('error', tryFallback);
                }, 100);
                
            } catch (error) {
                console.error('‚ùå Error in setupS3Player:', error);
            }
        }
        
        function restoreYouTubePlayer() {
            console.log('üîÑ Restoring YouTube player');
            
            try {
                // Restore original YouTube player methods if they were overridden
                if (window.player && window.player._s3Mode) {
                    console.log('üîÑ Restoring original YouTube player methods...');
                    window.player.getCurrentTime = window.player._originalGetCurrentTime;
                    window.player.getPlayerState = window.player._originalGetPlayerState;
                    window.player.getDuration = window.player._originalGetDuration;
                    delete window.player._s3Mode;
                    delete window.player._originalGetCurrentTime;
                    delete window.player._originalGetPlayerState;
                    delete window.player._originalGetDuration;
                    console.log('‚úÖ Original YouTube player methods restored');
                }
                
                // Find the player container
            const playerContainer = document.getElementById('youtube-player');
                if (!playerContainer) {
                    console.error('‚ùå Player container not found for restoration');
                    return;
                }
                
                // Clear any existing content (including S3 player)
                playerContainer.innerHTML = '';
                
                // Create a new div for YouTube player
                const youtubeDiv = document.createElement('div');
                youtubeDiv.id = 'youtube-player';
                youtubeDiv.style.width = '100%';
                youtubeDiv.style.height = '100%';
                
                // Add it to the container
                playerContainer.appendChild(youtubeDiv);
                
                console.log('‚úÖ YouTube player container restored');
                
                // Reinitialize YouTube player if YT API is available
            if (window.YT && window.YT.Player) {
                    console.log('üîÑ Reinitializing YouTube player...');
                player = new YT.Player('youtube-player', {
                    height: '100%',
                    width: '100%',
                    videoId: '',
                    playerVars: {
                        'playsinline': 1,
                        'controls': 1,
                        'rel': 0,
                        'modestbranding': 1
                    },
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange
                    }
                });
                    console.log('‚úÖ YouTube player reinitialized');
                } else {
                    console.warn('‚ö†Ô∏è YouTube API not available for reinitialization');
                }
                
            } catch (error) {
                console.error('‚ùå Error restoring YouTube player:', error);
            }
        }
        
        function handleS3TimeUpdate() {
            try {
            const s3Player = document.getElementById('s3-video-player');
                if (!s3Player) {
                    console.warn('‚ö†Ô∏è S3 player not found in timeupdate handler');
                    return;
                }
            
            const currentTime = s3Player.currentTime;
            
            // Update current time for tracking functions
            if (window.player) {
                // Temporarily override player.getCurrentTime for S3 videos
                window.player.getCurrentTime = () => currentTime;
                    
                    // Also override other player methods to prevent errors
                    if (!window.player._s3Mode) {
                        window.player._s3Mode = true;
                        window.player._originalGetCurrentTime = window.player.getCurrentTime;
                        window.player._originalGetPlayerState = window.player.getPlayerState;
                        window.player._originalGetDuration = window.player.getDuration;
                        
                        // Override methods to work with S3 videos
                        window.player.getCurrentTime = () => currentTime;
                        window.player.getPlayerState = () => {
                            const s3Player = document.getElementById('s3-video-player');
                            if (s3Player) {
                                if (s3Player.paused) return 2; // Paused
                                if (s3Player.ended) return 0; // Ended
                                return 1; // Playing
                            }
                            return -1; // Unknown
                        };
                        window.player.getDuration = () => {
                            const s3Player = document.getElementById('s3-video-player');
                            return s3Player ? s3Player.duration : 0;
                        };
                        
                        console.log('‚úÖ YouTube player methods overridden for S3 compatibility');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error in handleS3TimeUpdate:', error);
            }
        }
        
        function handleS3Play() {
            try {
            console.log('‚ñ∂Ô∏è S3 video started playing');
            if (autoTriggerEnabled) {
                if (hasChapters && videoChapters.length > 0) {
                    startChapterTracking();
                } else {
                    startTimeTracking();
                }
                }
            } catch (error) {
                console.error('‚ùå Error in handleS3Play:', error);
            }
        }
        
        function handleS3Pause() {
            try {
            console.log('‚è∏Ô∏è S3 video paused');
            // Stop all tracking
            if (chapterTimer) {
                clearInterval(chapterTimer);
                chapterTimer = null;
            }
            if (timeTrackingTimer) {
                clearInterval(timeTrackingTimer);
                timeTrackingTimer = null;
                }
            } catch (error) {
                console.error('‚ùå Error in handleS3Pause:', error);
            }
        }
        
        function handleS3Ended() {
            try {
            console.log('‚èπÔ∏è S3 video ended');
            // Stop all tracking
            if (chapterTimer) {
                clearInterval(chapterTimer);
                chapterTimer = null;
            }
            if (timeTrackingTimer) {
                clearInterval(timeTrackingTimer);
                timeTrackingTimer = null;
            }
            } catch (error) {
                console.error('‚ùå Error in handleS3Ended:', error);
            }
        }

        async function processS3VideoForAI(s3Url) {
            // Process S3 video through backend API to enable AI features
            try {
                console.log('üöÄ Processing S3 video for AI features:', s3Url);
                
                // Show loading state
                document.getElementById('summary-text').textContent = 'Processing S3 video for AI features...';
                
                // Call the backend API to process the S3 video
                const response = await fetch(`${apiBaseUrl}/process-video`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        video_url: s3Url,  // Use video_url field for S3
                        auto_trigger: autoTriggerEnabled,
                        trigger_interval: triggerInterval,
                        show_avatar: showAvatar,
                        bgm_enabled: bgmEnabled
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('S3 video processing result:', result);
                
                if (result.success) {
                    // Initialize video segments with real data from S3 video
                    videoSegments = result.segments || [];
                    currentSegmentIndex = 0;
                    lastTriggerTime = 0;
                    
                    console.log(`‚úÖ S3 video processed successfully!`);
                    console.log(`üìπ Video title: ${result.video_title}`);
                    console.log(`üìù Found ${videoSegments.length} segments`);
                    console.log(`‚è±Ô∏è Total duration: ${result.total_duration}s`);
                    
                    // Update UI with video title
                    const header = document.querySelector('.header h1');
                    if (header) {
                        header.textContent = `üéì ${result.video_title}`;
                    }
                    
                    // Enable AI features
                    console.log('ü§ñ Enabling AI features for S3 video...');
                    
                    // Show success message
                    document.getElementById('summary-text').textContent = `‚úÖ S3 video processed! AI features enabled. Video will pause every ${triggerInterval} seconds for learning points.`;
                    
                    // Start time-based tracking for AI pop-ups
                    if (autoTriggerEnabled) {
                        console.log('‚è∞ Starting AI time-based tracking for S3 video');
                        startTimeTracking();
                    }
                    
                    console.log('üéâ S3 video AI features fully enabled!');
                    
                } else {
                    console.error('‚ùå S3 video processing failed:', result.error);
                    document.getElementById('summary-text').textContent = `‚ùå Error processing S3 video: ${result.error}`;
                    
                    // Fallback: create dummy segments for basic functionality
                    createDummySegmentsForS3();
                }
                
            } catch (error) {
                console.error('‚ùå Error processing S3 video for AI:', error);
                document.getElementById('summary-text').textContent = `‚ùå Error: ${error.message}`;
                
                // Fallback: create dummy segments for basic functionality
                createDummySegmentsForS3();
            }
        }
        
        function createDummySegmentsForS3() {
            // Create fallback dummy segments for S3 video if processing fails
            console.log('üîÑ Creating fallback dummy segments for S3 video');
            
            // Create dummy segments based on video duration (estimate)
            const estimatedDuration = 120; // 2 minutes default
            const segmentDuration = 30; // 30 seconds per segment
            
            videoSegments = [];
            for (let i = 0; i < Math.ceil(estimatedDuration / segmentDuration); i++) {
                const start = i * segmentDuration;
                const end = Math.min((i + 1) * segmentDuration, estimatedDuration);
                
                videoSegments.push({
                    start: start,
                    end: end,
                    transcript: `S3 video segment ${i + 1} (${start}s - ${end}s)`,
                    summary: `This is segment ${i + 1} of the S3 video. Continue watching to learn more.`
                });
            }
            
            currentSegmentIndex = 0;
            lastTriggerTime = 0;
            
            console.log(`‚úÖ Created ${videoSegments.length} fallback segments for S3 video`);
            document.getElementById('summary-text').textContent = `‚ö†Ô∏è Using fallback mode. AI features limited.`;
        }

        async function processYouTubeVideoForAI(videoId) {
            // Process YouTube video through backend API to enable AI features
            try {
                console.log('üöÄ Processing YouTube video for AI features:', videoId);
                
                // Show loading state
                document.getElementById('summary-text').textContent = 'Processing YouTube video for AI features...';
                
                // First, check if video has chapters
                console.log('üîç Checking for video chapters...');
                let hasChaptersFromAPI = false;
                let chaptersFromAPI = [];
                
                try {
                    const chaptersResponse = await fetch(`${apiBaseUrl}/video-chapters/${videoId}`);
                    if (chaptersResponse.ok) {
                        const chaptersData = await chaptersResponse.json();
                        console.log('Chapters API response:', chaptersData);
                        
                        if (chaptersData.success && chaptersData.has_chapters) {
                            hasChaptersFromAPI = true;
                            chaptersFromAPI = chaptersData.chapters || [];
                            console.log('‚úÖ Video has chapters from API:', chaptersFromAPI.length);
                        } else {
                            console.log('‚è∞ Video has no chapters, will use time-based mode');
                        }
                    }
                } catch (chapterError) {
                    console.warn('‚ö†Ô∏è Could not check chapters, will use time-based mode:', chapterError);
                }
                
                // Call the backend API to process the YouTube video
                const response = await fetch(`${apiBaseUrl}/process-video`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        video_url: `https://www.youtube.com/watch?v=${videoId}`,  // Convert ID back to URL
                        auto_trigger: autoTriggerEnabled,
                        trigger_interval: triggerInterval,
                        show_avatar: showAvatar,
                        bgm_enabled: bgmEnabled
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('YouTube video processing result:', result);
                
                if (result.success) {
                    // Initialize video segments with real data from YouTube video
                    videoSegments = result.segments || [];
                    currentSegmentIndex = 0;
                    lastTriggerTime = 0;
                    
                    console.log(`‚úÖ YouTube video processed successfully!`);
                    console.log(`üìπ Video title: ${result.video_title}`);
                    console.log(`üìù Found ${videoSegments.length} segments`);
                    console.log(`‚è±Ô∏è Total duration: ${result.total_duration}s`);
                    
                    // Update UI with video title
                    const header = document.querySelector('.header h1');
                    if (header) {
                        header.textContent = `üéì ${result.video_title}`;
                    }
                    
                    // Enable AI features
                    console.log('ü§ñ Enabling AI features for YouTube video...');
                    
                    // Show success message
                    document.getElementById('summary-text').textContent = `‚úÖ YouTube video processed! AI features enabled. Video will pause every ${triggerInterval} seconds for learning points.`;
                    
                    // Start time-based tracking for AI pop-ups
                    if (autoTriggerEnabled) {
                        console.log('‚è∞ Starting AI time-based tracking for YouTube video');
                        startTimeTracking();
                    }
                    
                    console.log('üéâ YouTube video AI features fully enabled!');
                    
                } else {
                    console.error('‚ùå YouTube video processing failed:', result.error);
                    document.getElementById('summary-text').textContent = `‚ùå Error processing YouTube video: ${result.error}`;
                    
                    // Fallback: create dummy segments for basic functionality
                    createDummySegmentsForYouTube();
                }
                
            } catch (error) {
                console.error('‚ùå Error processing YouTube video for AI:', error);
                document.getElementById('summary-text').textContent = `‚ùå Error: ${error.message}`;
                
                // Fallback: create dummy segments for basic functionality
                createDummySegmentsForYouTube();
            }
        }
        
        function createDummySegmentsForYouTube() {
            // Create fallback dummy segments for YouTube video if processing fails
            console.log('üîÑ Creating fallback dummy segments for YouTube video');
            
            // Create dummy segments based on video duration (estimate)
            const estimatedDuration = 120; // 2 minutes default
            const segmentDuration = 30; // 30 seconds per segment
            
            videoSegments = [];
            for (let i = 0; i < Math.ceil(estimatedDuration / segmentDuration); i++) {
                const start = i * segmentDuration;
                const end = Math.min((i + 1) * segmentDuration, estimatedDuration);
                
                videoSegments.push({
                    start: start,
                    end: end,
                    transcript: `YouTube video segment ${i + 1} (${start}s - ${end}s)`,
                    summary: `This is segment ${i + 1} of the YouTube video. Continue watching to learn more.`
                });
            }
            
            currentSegmentIndex = 0;
            lastTriggerTime = 0;
            
            console.log(`‚úÖ Created ${videoSegments.length} fallback segments for YouTube video`);
            document.getElementById('summary-text').textContent = `‚ö†Ô∏è Using fallback mode. AI features limited.`;
        }

        // ---- Vime S3 player setup ----
        function setupS3PlayerWithVime(s3Url) {
            const ytContainer = document.getElementById('youtube-player');
            const s3Container = document.getElementById('s3-player') || ytContainer;
            if (!ytContainer) return;

            // Tear down YouTube iframe to avoid conflicts
            try {
                if (window.player && typeof window.player.stopVideo === 'function') window.player.stopVideo();
                if (window.player && typeof window.player.destroy === 'function') window.player.destroy();
            } catch (e) {}

            window.currentVideoType = 's3';
            if (!window.player) window.player = {};
            window.player.getCurrentTime = () => 0;
            window.player.getDuration = () => 0;
            window.player.getPlayerState = () => -1;

            // Show S3 container, hide YT
            if (s3Container && s3Container.id === 's3-player') {
                ytContainer.style.display = 'none';
                s3Container.style.display = '';
                s3Container.innerHTML = '';
            } else {
                ytContainer.innerHTML = '';
            }

            const playable = `${apiBaseUrl}/s3-playable?url=${encodeURIComponent(s3Url)}`;
            const proxy = `${apiBaseUrl}/s3-proxy?url=${encodeURIComponent(s3Url)}`;

            const mountTarget = (s3Container && s3Container.id === 's3-player' ? s3Container : ytContainer);

            const renderVime = () => {
                // Build Vime tree (vm-* custom elements)
                const vPlayer = document.createElement('vm-player');
                vPlayer.setAttribute('controls', '');
                vPlayer.setAttribute('playsinline', '');
                vPlayer.setAttribute('preload', 'metadata');
                vPlayer.setAttribute('cross-origin', 'anonymous');
                vPlayer.style.width = '100%';
                vPlayer.style.height = '100%';
                vPlayer.style.minHeight = '480px';
                vPlayer.style.borderRadius = '12px';
                vPlayer.style.background = '#000';
                vPlayer.style.display = 'block';

                const vVideo = document.createElement('vm-video');
                vVideo.setAttribute('cross-origin', 'anonymous');
                vVideo.style.width = '100%';
                vVideo.style.height = '100%';
                
                const source = document.createElement('source');
                source.src = playable;
                source.type = 'video/mp4';
                vVideo.appendChild(source);

                const ui = document.createElement('vm-ui');
                const ctrls = document.createElement('vm-controls');
                ctrls.appendChild(document.createElement('vm-playback-control'));
                ctrls.appendChild(document.createElement('vm-volume-control'));
                ctrls.appendChild(document.createElement('vm-time-progress'));
                ctrls.appendChild(document.createElement('vm-fullscreen-control'));
                ui.appendChild(ctrls);

                vPlayer.appendChild(vVideo);
                vPlayer.appendChild(ui);

                mountTarget.appendChild(vPlayer);

                // Wait for player to be ready
                setTimeout(() => {
                    // Set up event listeners
                    vPlayer.addEventListener('timeupdate', () => {
                        const t = vPlayer.currentTime || 0;
                        window.player.getCurrentTime = () => t;
                    });
                    
                    vPlayer.addEventListener('play', () => {
                        handleS3Play();
                        // Ensure audio is enabled
                        if (vPlayer.muted) {
                            vPlayer.muted = false;
                        }
                        console.log('üéµ S3 video playing, audio should be enabled');
                    });
                    
                    vPlayer.addEventListener('pause', handleS3Pause);
                    vPlayer.addEventListener('ended', handleS3Ended);
                    
                    vPlayer.addEventListener('loadedmetadata', () => {
                        window.player.getDuration = () => vPlayer.duration || 0;
                        window.player.getPlayerState = () => {
                            if (vPlayer.ended) return 0;
                            if (vPlayer.paused) return 2;
                            return 1;
                        };
                        
                        // Ensure audio is enabled
                        vPlayer.muted = false;
                        vPlayer.volume = 1.0;
                        
                        console.log('üé¨ S3 video metadata loaded, duration:', vPlayer.duration);
                        console.log('üîä Audio settings - muted:', vPlayer.muted, 'volume:', vPlayer.volume);
                        
                        // Try to start playback
                        vPlayer.play().catch(e => {
                            console.log('‚è∏Ô∏è Autoplay blocked, user needs to click to start');
                        });
                    });
                    
                    vPlayer.addEventListener('error', (e) => {
                        console.log('‚ùå Vime player error, trying proxy fallback:', e);
                        const srcEl = vPlayer.querySelector('source');
                        if (srcEl && srcEl.src.includes('/s3-playable')) {
                            srcEl.src = proxy;
                            vPlayer.load();
                        }
                    });

                    window.getS3CurrentTime = () => vPlayer.currentTime || 0;
                    
                    // Add a test function to manually enable audio
                    window.testS3Audio = () => {
                        if (vPlayer) {
                            vPlayer.muted = false;
                            vPlayer.volume = 1.0;
                            console.log('üîä Manual audio test - muted:', vPlayer.muted, 'volume:', vPlayer.volume);
                            return true;
                        }
                        return false;
                    };
                    
                }, 100);
            };

            // Wait until custom elements are defined before rendering
            const ensureDefined = async () => {
                try {
                    if (customElements && customElements.whenDefined) {
                        await customElements.whenDefined('vm-player');
                        await customElements.whenDefined('vm-video');
                        await customElements.whenDefined('vm-ui');
                        await customElements.whenDefined('vm-controls');
                    }
                } catch (_) {}
                renderVime();
            };

            ensureDefined();
        }
    </script>
</body>
</html> 