<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Learning Video Player</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .url-input-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .url-input {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .url-input input {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .url-input button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .url-input button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .url-input button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .url-input button:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .player-container {
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
        }

        #youtube-player {
            width: 100%;
            height: 500px;
            border-radius: 15px;
            overflow: hidden;
        }

        .floating-cta {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .floating-cta:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.4);
        }

        .floating-cta:active {
            transform: translateY(-1px);
        }

        .glassmorphic-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border-radius: 30px;
            padding: 45px;
            max-width: 600px;
            width: 90%;
            box-shadow: 
                0 32px 64px rgba(0, 0, 0, 0.3),
                0 16px 32px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.4);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glassmorphic-popup.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .popup-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(0,0,0,0.1);
            color: #333;
        }

        .popup-content {
            margin-bottom: 25px;
        }

        .summary-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .summary-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .summary-text {
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .transcript-section {
            background: rgba(0,0,0,0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .transcript-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .transcript-text {
            line-height: 1.5;
            font-size: 0.9rem;
            color: #666;
            max-height: 200px;
            overflow-y: auto;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 8px;
        }

        .popup-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-top: 20px;
        }

        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .primary-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .secondary-btn {
            background: rgba(0,0,0,0.1);
            color: #333;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        /* AI Avatar Styles */
        .avatar-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .avatar-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 24px;
            justify-content: center;
        }
        .avatar-video-container {
            margin-right: 0;
        }


        .avatar-video-container {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .avatar-video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-status {
            font-size: 0.9rem;
            color: white;
            opacity: 0.9;
            text-align: center;
        }

        .settings-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
        }

        .settings-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: white;
        }

        .setting-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: white;
        }

        .setting-label {
            font-weight: 500;
        }

        .setting-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: rgba(255,255,255,0.3);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle-switch.active::after {
            transform: translateX(25px);
        }

        .interval-input {
            width: 80px;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.9);
            text-align: center;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.1rem;
            margin: 40px 0;
        }

        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        /* New styles for AI Avatar */
        .avatar-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .avatar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .avatar-video-container {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .avatar-video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-status {
            font-size: 0.9rem;
            color: white;
            opacity: 0.9;
            text-align: center;
        }

        /* Animated Avatar Placeholder */
        .avatar-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .avatar-face {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .avatar-eyes {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .avatar-eye {
            width: 12px;
            height: 12px;
            background: #4a90e2;
            border-radius: 50%;
            position: relative;
            animation: blink 4s infinite;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .avatar-eye::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 4px;
            height: 4px;
            background: #fff;
            border-radius: 50%;
        }

        .avatar-eye.left {
            animation-delay: 0s;
        }

        .avatar-eye.right {
            animation-delay: 0s;
        }

        .avatar-mouth {
            width: 24px;
            height: 12px;
            border: 2px solid #333;
            border-top: none;
            border-radius: 0 0 24px 24px;
            animation: talk 2s infinite;
            transition: all 0.3s ease;
        }

        @keyframes blink {
            0%, 85%, 100% { 
                transform: scaleY(1); 
                opacity: 1;
            }
            90%, 95% { 
                transform: scaleY(0.1); 
                opacity: 0.3;
            }
        }

        @keyframes talk {
            0%, 100% { 
                transform: scaleY(1); 
                border-radius: 0 0 24px 24px;
            }
            50% { 
                transform: scaleY(1.3); 
                border-radius: 0 0 20px 20px;
            }
        }

        .avatar-section.talking .avatar-mouth {
            animation: talk 0.3s infinite;
            background: #ff6b9d;
            border-color: #ff6b9d;
            border-radius: 0 0 30px 30px;
            transform: scaleY(1.2);
        }

        /* Chat Interface Styles */
        .chat-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            max-height: 350px;
            overflow: hidden;
        }

        .chat-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
            text-align: center;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 250px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 12px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            max-height: 150px;
        }

        .chat-message {
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
        }

        .chat-message.user-message {
            align-items: flex-end;
        }

        .chat-message.bot-message {
            align-items: flex-start;
        }

        .message-content {
            max-width: 85%;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            line-height: 1.3;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .user-message .message-content {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .bot-message .message-content {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .chat-input-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        #chat-input {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 0.85rem;
            outline: none;
            max-width: 200px;
        }

        #chat-input:focus {
            background: white;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }

        #chat-send-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        #chat-send-btn:hover {
            background: white;
            transform: translateY(-1px);
        }

        #chat-send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #chat-toggle-btn {
            background: linear-gradient(135deg, #667eea, #764ba2) !important;
            color: white !important;
            font-size: 0.9rem;
            padding: 10px 16px;
            white-space: nowrap;
        }

        #chat-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        /* Ensure popup actions stay within bounds */
        .popup-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 18px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-top: 20px;
            flex-wrap: wrap;
            max-width: 100%;
        }

        .action-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: fit-content;
        }

        /* Ensure popup content doesn't overflow */
        .popup-content {
            margin-bottom: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            .chat-section {
                max-height: 300px;
                padding: 15px;
            }
            
            .chat-container {
                height: 200px;
            }
            
            .chat-messages {
                max-height: 120px;
            }
            
            .popup-actions {
                gap: 8px;
                padding: 15px;
            }
            
            .action-btn {
                padding: 8px 14px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎓 AI Learning Video Player</h1>
            <p>Transform any YouTube video into an interactive learning experience</p>
        </div>

        <div class="url-input-section">
            <div class="url-input">
                <input type="text" id="youtube-url" placeholder="Paste YouTube URL here..." />
                <button onclick="loadVideo()" disabled>⏳ Loading Player...</button>
            </div>
        </div>

        <div class="settings-panel">
            <div class="settings-title">⚙️ Player Settings</div>
            <div class="setting-group">
                <span class="setting-label">Auto-trigger pop-ups</span>
                <div class="setting-control">
                    <div class="toggle-switch" id="auto-trigger" onclick="toggleSetting('auto-trigger')"></div>
                </div>
            </div>
            <div class="setting-group">
                <span class="setting-label" for="trigger-interval">Interval (seconds)</span>
                <div class="setting-control">
                    <input type="number" class="interval-input" id="trigger-interval" value="30" min="10" max="120" />
                </div>
            </div>
            <div class="setting-group">
                <span class="setting-label">Show AI Avatar</span>
                <div class="setting-control">
                    <div class="toggle-switch" id="show-avatar" onclick="toggleSetting('show-avatar')"></div>
                </div>
            </div>
            <div class="setting-group">
                <span class="setting-label">Background Music</span>
                <div class="setting-control">
                    <div class="toggle-switch" id="bgm-enabled" onclick="toggleSetting('bgm-enabled')"></div>
                </div>
            </div>
        </div>

        <div class="player-container">
            <div id="youtube-player"></div>
            <button class="floating-cta avatar-cta hidden" id="explain-btn" onclick="triggerManualPopup()" style="background: none; box-shadow: none; padding: 0; border: none; width: 70px; height: 70px;">
                <img src="avatar_button.png" alt="Explain" style="width: 70px; height: 70px; border-radius: 50%; box-shadow: 0 4px 16px rgba(0,0,0,0.18); border: 3px solid #fff; background: #f8f8ff; object-fit: cover;" />
            </button>
        </div>

        <div class="loading hidden" id="loading">
            <div class="spinner"></div>
            <div>Processing video and generating AI insights...</div>
        </div>
    </div>

    <!-- Glassmorphic Popup -->
    <div class="glassmorphic-popup" id="learning-popup">
        <div class="popup-header">
            <div class="popup-title">🤖 AI Learning Assistant</div>
            <button class="close-btn" onclick="closePopup()">×</button>
        </div>
        
        <div class="popup-content">
            <!-- AI Avatar Section -->
            <div class="avatar-section" id="avatar-section" style="display: none;">
                <div class="avatar-container">
                    <div class="avatar-video-container">
                        <div class="avatar-placeholder">
                            <div class="avatar-face">
                                <div class="avatar-eyes">
                                    <div class="avatar-eye left"></div>
                                    <div class="avatar-eye right"></div>
                                </div>
                                <div class="avatar-mouth"></div>
                            </div>
                        </div>
                    </div>
                    <div class="avatar-status">🤖 AI Avatar Explaining...</div>
                </div>
            </div>
            
            <div class="summary-section">
                <div class="summary-title">📝 AI Summary</div>
                <div class="summary-text" id="summary-text">
                    Loading AI-generated summary...
                </div>
            </div>
            
            <div class="chat-section" id="chat-section" style="display: none;">
                <div class="chat-title">💬 Ask Questions About This Video</div>
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <div class="chat-message bot-message">
                            <div class="message-content">
                                Hi! I'm here to help you understand this video better. Ask me any questions about what was discussed!
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chat-input" placeholder="Type your question here..." maxlength="500" />
                        <button id="chat-send-btn" onclick="sendChatMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="popup-actions">
            <button id="ai-narration-btn" class="action-btn secondary-btn" style="display:none;">▶️ Start AI Narration</button>
            <button id="chat-toggle-btn" class="action-btn secondary-btn" onclick="toggleChat()">
                💬 Ask Questions
            </button>
            <button class="action-btn secondary-btn" onclick="closePopup()">
                ✋ Continue Watching
            </button>
        </div>
    </div>

    <script>
        // Global variables
        let player;
        let currentVideoId = '';
        let videoSegments = [];
        let currentSegmentIndex = 0;
        let autoTriggerEnabled = false;
        let triggerInterval = 30;
        let showAvatar = false;
        let bgmEnabled = false;
        let lastTriggerTime = 0;
        let isProcessing = false;
        let apiBaseUrl = 'http://localhost:8002';
        
        // New variables for chapter-based system
        let videoChapters = [];
        let hasChapters = false;
        let currentChapterIndex = 0;
        let chapterTimer = null;
        let timeTrackingTimer = null; // Add this for time-based tracking
        
        // HeyGen Avatar URLs - Random selection of professional avatars
        const avatarUrls = [
            'https://app.heygen.com/avatar/65f7c8b8e4b0b8b8b8b8b8b8', // Professional male
            'https://app.heygen.com/avatar/65f7c8b8e4b0b8b8b8b8b8b9', // Professional female
            'https://app.heygen.com/avatar/65f7c8b8e4b0b8b8b8b8b8ba', // Casual male
            'https://app.heygen.com/avatar/65f7c8b8e4b0b8b8b8b8b8bb', // Casual female
            'https://app.heygen.com/avatar/65f7c8b8e4b0b8b8b8b8b8bc'  // Friendly instructor
        ];

        // AI Narration audio state
        let aiNarrationAudio = null;
        let isNarrationPlaying = false;

        // YouTube API callback
        function onYouTubeIframeAPIReady() {
            console.log('YouTube API ready, initializing player...');
            player = new YT.Player('youtube-player', {
                height: '500',
                width: '100%',
                videoId: '',
                playerVars: {
                    'playsinline': 1,
                    'controls': 1,
                    'rel': 0
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }

        function onPlayerReady(event) {
            console.log('YouTube player ready');
            // Enable the load button
            document.querySelector('.url-input button').disabled = false;
            document.querySelector('.url-input button').textContent = '🚀 Load Video';
        }

        function onPlayerError(event) {
            console.error('YouTube player error:', event);
            alert('Error loading YouTube player. Please refresh the page and try again.');
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.PLAYING) {
                // Only start tracking if auto-trigger is enabled and no tracking is currently active
                if (autoTriggerEnabled) {
                    if (hasChapters && videoChapters.length > 0 && !chapterTimer) {
                        startChapterTracking();
                        console.log('Player playing - started chapter tracking');
                    } else if (!hasChapters && !timeTrackingTimer) {
                        startTimeTracking();
                        console.log('Player playing - started time-based tracking');
                    }
                }
            } else if (event.data === YT.PlayerState.PAUSED) {
                // Stop all tracking
                if (chapterTimer) {
                    clearInterval(chapterTimer);
                    chapterTimer = null;
                }
                if (timeTrackingTimer) {
                    clearInterval(timeTrackingTimer);
                    timeTrackingTimer = null;
                }
            }
        }

        async function loadVideo() {
            const url = document.getElementById('youtube-url').value;
            const videoId = extractVideoId(url);
            
            if (!videoId) {
                alert('Please enter a valid YouTube URL');
                return;
            }

            // Check if player is ready
            if (!player || !player.loadVideoById) {
                alert('YouTube player is not ready yet. Please wait a moment and try again.');
                return;
            }

            currentVideoId = videoId;
            
            // Show loading state
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('explain-btn').classList.add('hidden');
            
            try {
                // Load the video first
                player.loadVideoById(videoId);
                
                // First, check if video has chapters
                console.log('Checking for video chapters...');
                console.log('API URL:', `${apiBaseUrl}/video-chapters/${videoId}`);
                
                try {
                    const chaptersResponse = await fetch(`${apiBaseUrl}/video-chapters/${videoId}`);
                    console.log('Chapters response status:', chaptersResponse.status);
                    
                    if (!chaptersResponse.ok) {
                        throw new Error(`HTTP ${chaptersResponse.status}: ${chaptersResponse.statusText}`);
                    }
                    
                    const chaptersData = await chaptersResponse.json();
                    console.log('Raw chapters response:', chaptersData);
                    
                    if (chaptersData.success) {
                        hasChapters = chaptersData.has_chapters;
                        videoChapters = chaptersData.chapters || [];
                        
                        console.log('Chapter detection result:', {
                            success: chaptersData.success,
                            hasChapters: hasChapters,
                            chaptersCount: videoChapters.length,
                            chapters: videoChapters,
                            totalChapters: chaptersData.total_chapters
                        });
                        
                        // Additional validation
                        if (videoChapters && Array.isArray(videoChapters) && videoChapters.length > 0) {
                            console.log('✅ Chapters array is valid and contains data');
                            console.log('First chapter:', videoChapters[0]);
                            console.log('Chapter structure:', Object.keys(videoChapters[0]));
                        } else {
                            console.log('❌ Chapters array is invalid or empty');
                            console.log('videoChapters type:', typeof videoChapters);
                            console.log('videoChapters length:', videoChapters ? videoChapters.length : 'undefined');
                        }
                        
                        if (hasChapters && videoChapters.length > 0) {
                            console.log(`🎯 Video has ${videoChapters.length} chapters:`, videoChapters);
                            
                            // CRITICAL: Stop any existing time-based tracking immediately
                            if (timeTrackingTimer) {
                                clearInterval(timeTrackingTimer);
                                timeTrackingTimer = null;
                                console.log('🛑 Stopped existing time-based tracking');
                            }
                            
                            // Update UI to show chapter-based mode
                            document.querySelector('.setting-label[for="trigger-interval"]').textContent = 'Chapter-based (auto)';
                            document.getElementById('trigger-interval').disabled = true;
                            document.getElementById('trigger-interval').value = 'Chapters';
                            
                            // Force hasChapters to true if we have chapters
                            hasChapters = true;
                            console.log('✅ Chapter mode activated');
                        } else {
                            console.log('⏰ Video has no chapters, using time-based intervals');
                            
                            // CRITICAL: Stop any existing chapter-based tracking immediately
                            if (chapterTimer) {
                                clearInterval(chapterTimer);
                                chapterTimer = null;
                                console.log('🛑 Stopped existing chapter-based tracking');
                            }
                            
                            // Update UI to show time-based mode
                            document.querySelector('.setting-label[for="trigger-interval"]').textContent = 'Interval (seconds)';
                            document.getElementById('trigger-interval').disabled = false;
                            document.getElementById('trigger-interval').value = '30';
                            
                            // Force hasChapters to false if no chapters
                            hasChapters = false;
                            videoChapters = [];
                            console.log('✅ Time-based mode activated');
                        }
                    } else {
                        console.log('❌ Could not check chapters, defaulting to time-based mode');
                        console.log('Error from API:', chaptersData.error);
                        hasChapters = false;
                        videoChapters = [];
                    }
                } catch (chapterError) {
                    console.error('❌ Error checking chapters:', chapterError);
                    console.log('Defaulting to time-based mode due to chapter check error');
                    hasChapters = false;
                    videoChapters = [];
                }
                
                console.log('Making API request to:', `${apiBaseUrl}/process-video`);
                console.log('Request payload:', {
                    youtube_url: url,
                    auto_trigger: autoTriggerEnabled,
                    trigger_interval: triggerInterval,
                    show_avatar: showAvatar,
                    bgm_enabled: bgmEnabled
                });
                
                // Process video with real API
                const response = await fetch(`${apiBaseUrl}/process-video`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        youtube_url: url,
                        auto_trigger: autoTriggerEnabled,
                        trigger_interval: triggerInterval,
                        show_avatar: showAvatar,
                        bgm_enabled: bgmEnabled
                    })
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('API response:', result);
                
                if (result.success) {
                    // Initialize video segments with real data
                    videoSegments = result.segments; // Preserve all fields, including 'words'
                    
                    currentSegmentIndex = 0;
                    lastTriggerTime = 0;
                    currentChapterIndex = 0;
                    
                    // Update UI with video title
                    document.querySelector('.header h1').textContent = `🎓 ${result.video_title}`;
                    
                    console.log(`Processed video: ${result.video_title}`);
                    console.log(`Found ${videoSegments.length} segments`);
                    
                    // Start appropriate tracking based on whether video has chapters
                    if (hasChapters && videoChapters.length > 0) {
                        console.log('🎯 Starting chapter-based tracking');
                        console.log('Chapter data:', videoChapters);
                        
                        // Ensure any existing timers are cleared first
                        if (timeTrackingTimer) {
                            clearInterval(timeTrackingTimer);
                            timeTrackingTimer = null;
                            console.log('🛑 Cleared time tracking timer');
                        }
                        if (chapterTimer) {
                            clearInterval(chapterTimer);
                            chapterTimer = null;
                            console.log('🛑 Cleared chapter timer');
                        }
                        
                        // Force the state to be correct
                        hasChapters = true;
                        console.log('✅ Chapter mode confirmed - hasChapters:', hasChapters);
                        
                        startChapterTracking();
                        debugTrackingState(); // Debug the state
                    } else {
                        console.log('⏰ Starting time-based tracking');
                        console.log('No chapters detected - hasChapters:', hasChapters, 'chaptersCount:', videoChapters.length);
                        
                        // Ensure any existing timers are cleared first
                        if (chapterTimer) {
                            clearInterval(chapterTimer);
                            chapterTimer = null;
                            console.log('🛑 Cleared chapter timer');
                        }
                        if (timeTrackingTimer) {
                            clearInterval(timeTrackingTimer);
                            timeTrackingTimer = null;
                            console.log('🛑 Cleared time tracking timer');
                        }
                        
                        // Force the state to be correct
                        hasChapters = false;
                        videoChapters = [];
                        console.log('✅ Time-based mode confirmed - hasChapters:', hasChapters);
                        
                        startTimeTracking();
                        debugTrackingState(); // Debug the state
                    }
                } else {
                    throw new Error(result.error || 'Failed to process video');
                }
                
            } catch (error) {
                console.error('Error processing video:', error);
                console.error('Error details:', error);
                
                let errorMessage = 'Unknown error occurred';
                if (error.message) {
                    errorMessage = error.message;
                } else if (error.response) {
                    errorMessage = `HTTP ${error.response.status}: ${error.response.statusText}`;
                }
                
                alert(`Error processing video: ${errorMessage}`);
                
                // Don't use fallback data - show real error
                // initializeDummySegments();
            } finally {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('explain-btn').classList.remove('hidden');
            }
        }

        function initializeDummySegments() {
            // Fallback dummy segments for testing
            videoSegments = [
                {
                    start: 0,
                    end: 30,
                    transcript: "Welcome to this comprehensive guide on artificial intelligence and machine learning. In this video, we'll explore the fundamental concepts that drive modern AI systems and how they're transforming our world.",
                    summary: "Introduction to AI and ML concepts, setting the foundation for understanding modern technology and its applications."
                },
                {
                    start: 30,
                    end: 60,
                    transcript: "Machine learning algorithms can be broadly categorized into supervised, unsupervised, and reinforcement learning. Each type serves different purposes and applications in solving real-world problems.",
                    summary: "Overview of the three main types of machine learning algorithms and their practical applications in various industries."
                },
                {
                    start: 60,
                    end: 90,
                    transcript: "Deep learning uses neural networks with multiple layers to process complex patterns. These networks can learn hierarchical representations of data, making them powerful for tasks like image recognition and natural language processing.",
                    summary: "Explanation of deep learning and neural network architecture for complex pattern recognition and advanced AI applications."
                },
                {
                    start: 90,
                    end: 120,
                    transcript: "The future of AI lies in combining these different approaches to create more intelligent and adaptable systems that can learn and evolve over time.",
                    summary: "Future prospects of AI technology and the potential for creating more advanced, adaptive intelligent systems."
                }
            ];
            
            currentSegmentIndex = 0;
            lastTriggerTime = 0;
            
            console.log('Initialized dummy segments:', videoSegments.length, 'segments');
        }

        function extractVideoId(url) {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        function startTimeTracking() {
            if (autoTriggerEnabled && !hasChapters && videoChapters.length === 0) {
                // Clear any existing timers first
                if (chapterTimer) {
                    clearInterval(chapterTimer);
                    chapterTimer = null;
                }
                if (timeTrackingTimer) {
                    clearInterval(timeTrackingTimer);
                    timeTrackingTimer = null;
                }
                timeTrackingTimer = setInterval(checkAutoTrigger, 1000);
                console.log('Started time-based tracking');
            }
        }

        function startChapterTracking() {
            console.log('🚀 startChapterTracking called with:', {
                autoTriggerEnabled,
                hasChapters,
                chaptersCount: videoChapters.length
            });
            
            if (autoTriggerEnabled && hasChapters && videoChapters.length > 0) {
                // Clear any existing timer
                if (chapterTimer) {
                    clearInterval(chapterTimer);
                    console.log('🛑 Cleared existing chapter timer');
                }
                if (timeTrackingTimer) {
                    clearInterval(timeTrackingTimer);
                    timeTrackingTimer = null;
                    console.log('🛑 Cleared time tracking timer');
                }
                
                // Check every second for chapter transitions
                chapterTimer = setInterval(checkChapterTransition, 1000);
                console.log('✅ Started chapter-based tracking with timer ID:', chapterTimer);
                console.log('📊 Chapter data available:', videoChapters);
            } else {
                console.log('❌ startChapterTracking blocked:', {
                    autoTriggerEnabled,
                    hasChapters,
                    chaptersCount: videoChapters.length
                });
            }
        }

        function stopTimeTracking() {
            // Stop all tracking modes
            if (chapterTimer) {
                clearInterval(chapterTimer);
                chapterTimer = null;
            }
            if (timeTrackingTimer) {
                clearInterval(timeTrackingTimer);
                timeTrackingTimer = null;
            }
        }

        function checkChapterTransition() {
            if (!autoTriggerEnabled || isProcessing || !hasChapters || videoChapters.length === 0) {
                console.log('🚫 Chapter transition check blocked:', {
                    autoTriggerEnabled,
                    isProcessing,
                    hasChapters,
                    chaptersCount: videoChapters.length
                });
                return;
            }
            
            const currentTime = player.getCurrentTime();
            console.log(`🔍 Checking chapter transition at ${currentTime}s`);
            
            // Find current chapter
            const currentChapter = videoChapters.find(chapter => 
                currentTime >= chapter.start_time && currentTime <= chapter.end_time
            );
            
            if (currentChapter) {
                const chapterIndex = videoChapters.indexOf(currentChapter);
                console.log(`📍 Currently in chapter: ${currentChapter.title} (index: ${chapterIndex})`);
                
                // Only trigger popup when we're near the end of the current chapter (within 1 second)
                // Don't trigger on chapter start or transition
                const timeUntilChapterEnd = currentChapter.end_time - currentTime;
                if (timeUntilChapterEnd <= 1 && timeUntilChapterEnd > 0) {
                    console.log(`⏰ Near end of chapter: ${currentChapter.title}, triggering popup`);
                    triggerChapterPopup(currentChapter);
                }
            } else {
                console.log('❌ Not in any chapter at current time');
            }
        }

        function checkAutoTrigger() {
            // Multiple safety checks to ensure this never runs with chapters
            if (!autoTriggerEnabled || isProcessing || hasChapters || videoChapters.length > 0) {
                return;
            }
            
            const currentTime = player.getCurrentTime();
            const timeSinceLastTrigger = currentTime - lastTriggerTime;
            
            if (timeSinceLastTrigger >= triggerInterval) {
                console.log(`Time-based trigger: ${timeSinceLastTrigger}s elapsed, triggering popup`);
                triggerPopup();
                lastTriggerTime = currentTime;
            }
        }

        function triggerManualPopup() {
            triggerPopup();
        }

        async function triggerPopup(segmentIndex = null, manual = false) {
            if (isProcessing) return;
            isProcessing = true;
           // Always show popup and reset state
           document.getElementById('learning-popup').classList.add('active');
           // Reset AI narration button and state
           const narrationBtn = document.getElementById('ai-narration-btn');
           if (narrationBtn) {
               narrationBtn.textContent = '▶️ Start AI Narration';
               narrationBtn.disabled = false;
               narrationBtn.style.display = (showAvatar ? 'inline-block' : 'none');
           }
           if (aiNarrationAudio) {
               aiNarrationAudio.pause();
               aiNarrationAudio.currentTime = 0;
           }
           isNarrationPlaying = false;
           const avatarSection = document.getElementById('avatar-section');
           if (avatarSection) avatarSection.classList.remove('talking');
           setupAINarrationButton();
            
            const currentTime = player.getCurrentTime();
            
            // Find current segment
            const currentSegment = findCurrentSegment(currentTime);
            
            if (currentSegment) {
                // Pause video
                player.pauseVideo();
                
                // Show popup with loading state
                document.getElementById('summary-text').textContent = 'Generating time-specific explanation...';
                
                // Show avatar if enabled
                showAvatarInPopup();
                
                try {
                    // Generate time-specific explanation
                    const response = await fetch(`${apiBaseUrl}/learning-point`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            segment_index: videoSegments.indexOf(currentSegment),
                            timestamp: currentTime,
                            transcript: currentSegment.transcript,
                            current_time: currentTime,
                            segments: videoSegments // Pass all segments for accurate extraction
                        })
                    });

                    const result = await response.json();
                    console.log('Learning point API response:', result);
                    if (result.success && result.learning_point && result.learning_point.summary) {
                        // Update with time-specific explanation
                        document.getElementById('summary-text').textContent = result.learning_point.summary;
                        console.log('Generated time-specific explanation:', result.learning_point.summary);
                    } else if (result.error) {
                        document.getElementById('summary-text').textContent = 'Error: ' + result.error;
                    } else {
                        // Fallback to segment summary
                        document.getElementById('summary-text').textContent = currentSegment.summary;
                    }
                } catch (error) {
                    console.error('Error generating time-specific explanation:', error);
                    // Fallback to segment summary
                    document.getElementById('summary-text').textContent = currentSegment.summary;
                }
                
                // Play background music if enabled
                if (bgmEnabled) {
                    playBackgroundMusic();
                }

                // After updating summary text in triggerPopup, show Start AI Narration button if avatar is enabled
                const narrationBtn = document.getElementById('ai-narration-btn');
                if (showAvatar && narrationBtn) {
                    narrationBtn.style.display = 'inline-block';
                } else if (narrationBtn) {
                    narrationBtn.style.display = 'none';
                }
            }
            
            isProcessing = false;
        }

        async function triggerChapterPopup(chapter) {
            if (isProcessing) return;
            isProcessing = true;
            
            // Pause video
            player.pauseVideo();
            
            // Show popup
            document.getElementById('learning-popup').classList.add('active');
            document.getElementById('summary-text').textContent = `Chapter: ${chapter.title}\nGenerating chapter explanation...`;
            
            // Show avatar if enabled
            showAvatarInPopup();
            
            try {
                // Generate chapter-specific explanation
                const response = await fetch(`${apiBaseUrl}/learning-point`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        segment_index: currentChapterIndex,
                        timestamp: chapter.start_time,
                        transcript: `Chapter: ${chapter.title}`,
                        current_time: chapter.start_time,
                        segments: videoSegments,
                        chapter_info: {
                            title: chapter.title,
                            start_time: chapter.start_time,
                            end_time: chapter.end_time,
                            duration: chapter.duration
                        }
                    })
                });

                const result = await response.json();
                if (result.success && result.learning_point && result.learning_point.summary) {
                    document.getElementById('summary-text').textContent = result.learning_point.summary;
                } else if (result.error) {
                    document.getElementById('summary-text').textContent = 'Error: ' + result.error;
                } else {
                    document.getElementById('summary-text').textContent = `Chapter: ${chapter.title}\n\nThis chapter covers ${chapter.duration} seconds of content.`;
                }
            } catch (error) {
                console.error('Error generating chapter explanation:', error);
                document.getElementById('summary-text').textContent = `Chapter: ${chapter.title}\n\nThis chapter covers ${chapter.duration} seconds of content.`;
            }
            
            // Play background music if enabled
            if (bgmEnabled) {
                playBackgroundMusic();
            }
            
            // Show AI narration button if avatar is enabled
            const narrationBtn = document.getElementById('ai-narration-btn');
            if (showAvatar && narrationBtn) {
                narrationBtn.style.display = 'inline-block';
            } else if (narrationBtn) {
                narrationBtn.style.display = 'none';
            }
            
            isProcessing = false;
        }

        function findCurrentSegment(currentTime) {
            return videoSegments.find(segment => 
                currentTime >= segment.start && currentTime <= segment.end
            ) || videoSegments[0];
        }

        function closePopup() {
            document.getElementById('learning-popup').classList.remove('active');
            isProcessing = false;
            // Reset AI narration button and state
            const narrationBtn = document.getElementById('ai-narration-btn');
            if (narrationBtn) {
                narrationBtn.textContent = '▶️ Start AI Narration';
                narrationBtn.disabled = false;
                narrationBtn.style.display = 'none';
            }
            if (aiNarrationAudio) {
                aiNarrationAudio.pause();
                aiNarrationAudio.currentTime = 0;
            }
            isNarrationPlaying = false;
            const avatarSection = document.getElementById('avatar-section');
            if (avatarSection) avatarSection.classList.remove('talking');
            player.playVideo();
        }

        async function replaySummary() {
            const currentTime = player.getCurrentTime();
            const currentSegment = findCurrentSegment(currentTime);
            
            if (currentSegment) {
                try {
                    // Generate time-specific explanation using API
                    const response = await fetch(`${apiBaseUrl}/learning-point`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            segment_index: videoSegments.indexOf(currentSegment),
                            timestamp: currentTime,
                            transcript: currentSegment.transcript,
                            current_time: currentTime
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        // Update the popup with time-specific explanation
                        document.getElementById('summary-text').textContent = result.learning_point.summary;
                        console.log('Updated with time-specific explanation:', result.learning_point.summary);
                    }
                } catch (error) {
                    console.error('Error replaying summary:', error);
                }
            }
        }

        async function savePoint() {
            const currentTime = player.getCurrentTime();
            const currentSegment = findCurrentSegment(currentTime);
            
            if (currentSegment) {
                try {
                    const response = await fetch(`${apiBaseUrl}/learning-point`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            segment_index: videoSegments.indexOf(currentSegment),
                            timestamp: currentTime,
                            transcript: currentSegment.transcript,
                            current_time: currentTime
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Learning point saved! 📚');
                        console.log('Saved learning point:', result.learning_point);
                    } else {
                        throw new Error(result.error || 'Failed to save learning point');
                    }
                } catch (error) {
                    console.error('Error saving learning point:', error);
                    alert(`Error saving learning point: ${error.message}`);
                }
            }
        }

        function playBackgroundMusic() {
            // Implement background music (could use Web Audio API)
            console.log('Playing background music...');
        }

        function getRandomAvatar() {
            // Get a random avatar from the list
            const randomIndex = Math.floor(Math.random() * avatarUrls.length);
            return avatarUrls[randomIndex];
        }

        // Chat functionality
        let chatEnabled = false;
        let chatHistory = [];

        function toggleChat() {
            const chatSection = document.getElementById('chat-section');
            const chatToggleBtn = document.getElementById('chat-toggle-btn');
            
            if (chatEnabled) {
                chatSection.style.display = 'none';
                chatToggleBtn.textContent = '💬 Ask Questions';
                chatToggleBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2) !important';
            } else {
                chatSection.style.display = 'block';
                chatToggleBtn.textContent = '❌ Close Chat';
                chatToggleBtn.style.background = 'rgba(255,0,0,0.8) !important';
            }
            
            chatEnabled = !chatEnabled;
        }

        function sendChatMessage() {
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            const question = chatInput.value.trim();
            
            if (!question) return;
            
            // Disable input and button while processing
            chatInput.disabled = true;
            chatSendBtn.disabled = true;
            chatSendBtn.textContent = 'Sending...';
            
            // Add user message to chat
            addChatMessage(question, 'user');
            chatInput.value = '';
            
            // Get current video transcript
            const currentTime = player.getCurrentTime();
            const currentSegment = findCurrentSegment(currentTime);
            let videoTranscript = '';
            
            if (currentSegment && currentSegment.transcript) {
                videoTranscript = currentSegment.transcript;
            } else {
                // Fallback to all segments transcript
                videoTranscript = videoSegments.map(seg => seg.transcript).join(' ');
            }
            
            // Send question to API
            fetch(`${apiBaseUrl}/chat-question`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: question,
                    video_transcript: videoTranscript,
                    current_time: currentTime
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    addChatMessage(result.answer, 'bot');
                } else {
                    addChatMessage('Sorry, I encountered an error. Please try again.', 'bot');
                }
            })
            .catch(error => {
                console.error('Error sending chat message:', error);
                addChatMessage('Sorry, I encountered an error. Please try again.', 'bot');
            })
            .finally(() => {
                // Re-enable input and button
                chatInput.disabled = false;
                chatSendBtn.disabled = false;
                chatSendBtn.textContent = 'Send';
                chatInput.focus();
            });
        }

        function addChatMessage(message, sender) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = message;
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Store in history
            chatHistory.push({ sender, message, timestamp: new Date() });
        }

        // Debug function to check current state
        function debugTrackingState() {
            console.log('=== TRACKING STATE DEBUG ===');
            console.log('autoTriggerEnabled:', autoTriggerEnabled);
            console.log('hasChapters:', hasChapters);
            console.log('videoChapters:', videoChapters);
            console.log('currentChapterIndex:', currentChapterIndex);
            console.log('chapterTimer:', chapterTimer);
            console.log('timeTrackingTimer:', timeTrackingTimer);
            console.log('currentTime:', player ? player.getCurrentTime() : 'N/A');
            
            if (videoChapters.length > 0) {
                console.log('Chapter details:');
                videoChapters.forEach((chapter, index) => {
                    console.log(`  Chapter ${index}: ${chapter.title} (${chapter.start_time}s - ${chapter.end_time}s)`);
                });
            }
            console.log('==========================');
        }

        // Test function to manually check chapters
        async function testChapterDetection() {
            if (!currentVideoId) {
                console.log('❌ No video loaded. Please load a video first.');
                return;
            }
            
            console.log('🧪 Testing chapter detection for video:', currentVideoId);
            console.log('API URL:', `${apiBaseUrl}/video-chapters/${currentVideoId}`);
            
            try {
                const response = await fetch(`${apiBaseUrl}/video-chapters/${currentVideoId}`);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('📊 Raw API Response:', data);
                
                if (data.success) {
                    console.log('✅ API call successful');
                    console.log('has_chapters:', data.has_chapters);
                    console.log('total_chapters:', data.total_chapters);
                    console.log('chapters array:', data.chapters);
                    
                    if (data.chapters && Array.isArray(data.chapters)) {
                        console.log('📚 Chapters array is valid');
                        console.log('Array length:', data.chapters.length);
                        
                        if (data.chapters.length > 0) {
                            console.log('🎯 First chapter:', data.chapters[0]);
                            console.log('Chapter keys:', Object.keys(data.chapters[0]));
                        }
                    } else {
                        console.log('❌ Chapters array is invalid');
                        console.log('Type:', typeof data.chapters);
                    }
                } else {
                    console.log('❌ API call failed');
                    console.log('Error:', data.error);
                }
            } catch (error) {
                console.error('❌ Error testing chapter detection:', error);
            }
        }

        function showAvatarInPopup() {
            if (showAvatar) {
                const avatarSection = document.getElementById('avatar-section');
                if (!avatarSection) return;
                // Show avatar section
                avatarSection.style.display = 'block';
                // (No longer overwrite innerHTML here)
            } else {
                // Hide avatar section
                document.getElementById('avatar-section').style.display = 'none';
            }
        }

        function toggleSetting(settingId) {
            const toggle = document.getElementById(settingId);
            toggle.classList.toggle('active');
            
            switch(settingId) {
                case 'auto-trigger':
                    autoTriggerEnabled = toggle.classList.contains('active');
                    
                    // Start appropriate tracking based on video type
                    if (autoTriggerEnabled) {
                        if (hasChapters && videoChapters.length > 0) {
                            console.log('Auto-trigger enabled - starting chapter tracking');
                            startChapterTracking();
                        } else {
                            console.log('Auto-trigger enabled - starting time tracking');
                            startTimeTracking();
                        }
                    } else {
                        // Stop all tracking
                        console.log('Auto-trigger disabled - stopping all tracking');
                        if (chapterTimer) {
                            clearInterval(chapterTimer);
                            chapterTimer = null;
                        }
                        if (timeTrackingTimer) {
                            clearInterval(timeTrackingTimer);
                            timeTrackingTimer = null;
                        }
                    }
                    break;
                    
                case 'show-avatar':
                    showAvatar = toggle.classList.contains('active');
                    // Update avatar display if popup is currently open
                    if (document.getElementById('learning-popup').classList.contains('active')) {
                        showAvatarInPopup();
                    }
                    break;
                    
                case 'bgm-enabled':
                    bgmEnabled = toggle.classList.contains('active');
                    break;
            }
        }

        // Update interval when changed
        document.getElementById('trigger-interval').addEventListener('change', function() {
            triggerInterval = parseInt(this.value);
        });

        // Robustly attach event listener for Start/Stop AI Narration button
        function setupAINarrationButton() {
            const narrationBtn = document.getElementById('ai-narration-btn');
            if (!narrationBtn) return;
            // Remove previous listeners
            const newBtn = narrationBtn.cloneNode(true);
            narrationBtn.parentNode.replaceChild(newBtn, narrationBtn);
            newBtn.addEventListener('click', async function() {
                if (!isNarrationPlaying) {
                    newBtn.disabled = true;
                    newBtn.textContent = 'Loading...';
                    const summaryText = document.getElementById('summary-text').textContent;
                    const resp = await fetch(apiBaseUrl + '/tts-narration', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: summaryText, voice_id: 'RvxJMEXhmyfed4d7O5xn' })
                    });
                    const data = await resp.json();
                    if (data.success) {
                        aiNarrationAudio = new Audio('data:audio/mp3;base64,' + data.audio_base64);
                        isNarrationPlaying = true;
                        newBtn.textContent = '⏹️ Stop AI Narration';
                        newBtn.disabled = false;
                        const avatarSection = document.getElementById('avatar-section');
                        if (avatarSection) avatarSection.classList.add('talking');
                        aiNarrationAudio.play();
                        aiNarrationAudio.onended = () => {
                            isNarrationPlaying = false;
                            newBtn.textContent = '▶️ Start AI Narration';
                            if (avatarSection) avatarSection.classList.remove('talking');
                        };
                    } else {
                        newBtn.textContent = 'Error';
                        setTimeout(()=>{ newBtn.textContent = '▶️ Start AI Narration'; newBtn.disabled = false; }, 2000);
                    }
                } else {
                    if (aiNarrationAudio) {
                        aiNarrationAudio.pause();
                        aiNarrationAudio.currentTime = 0;
                    }
                    isNarrationPlaying = false;
                    newBtn.textContent = '▶️ Start AI Narration';
                    const avatarSection = document.getElementById('avatar-section');
                    if (avatarSection) avatarSection.classList.remove('talking');
                }
            });
        }

        // No global event listener needed for AI narration button
        document.addEventListener('DOMContentLoaded', function() {
            // Set default settings
            document.getElementById('auto-trigger').classList.add('active');
            autoTriggerEnabled = true;
            
            // Check if YouTube API loaded after 10 seconds
            setTimeout(function() {
                if (!player || !player.loadVideoById) {
                    console.warn('YouTube API not loaded, enabling fallback');
                    document.querySelector('.url-input button').disabled = false;
                    document.querySelector('.url-input button').textContent = '🚀 Load Video (Fallback)';
                }
            }, 10000);

            // Add event listener for Play AI Narration button
            const playBtn = document.getElementById('play-narration-btn');
            if (playBtn) {
                playBtn.addEventListener('click', async function() {
                    const summaryText = document.getElementById('summary-text').textContent;
                    playBtn.disabled = true;
                    playBtn.textContent = 'Loading...';
                    // Fetch TTS audio
                    const resp = await fetch(apiBaseUrl + '/tts-narration', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: summaryText, voice_id: 'RvxJMEXhmyfed4d7O5xn' })
                    });
                    const data = await resp.json();
                    if (data.success) {
                        // Play audio
                        const audio = new Audio('data:audio/mp3;base64,' + data.audio_base64);
                        // Animate avatar mouth
                        const avatarSection = document.getElementById('avatar-section');
                        if (avatarSection) avatarSection.classList.add('talking');
                        audio.play();
                        audio.onended = () => {
                            if (avatarSection) avatarSection.classList.remove('talking');
                            playBtn.disabled = false;
                            playBtn.textContent = '▶️ Play AI Narration';
                        };
                    } else {
                        playBtn.textContent = 'Error';
                        setTimeout(()=>{ playBtn.textContent = '▶️ Play AI Narration'; playBtn.disabled = false; }, 2000);
                    }
                });
            }

            // Add event listener for Start/Stop AI Narration button
            setupAINarrationButton();
            
            // Add Enter key support for chat input
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
            }
        });
    </script>
</body>
</html> 